<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=Shift_JIS">
<title>VA-300ドライバ: udp.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">src</a>&nbsp;/&nbsp;<a class="el" href="dir_000001.html">driver</a>&nbsp;/&nbsp;<a class="el" href="dir_000002.html">net</a></div>
<h1>udp.c</h1><a href="udp_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
00014 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00015 <span class="preprocessor">#include &lt;string.h&gt;</span>
00016 <span class="preprocessor">#include "kernel.h"</span>
00017 <span class="preprocessor">#include "nonet.h"</span>
00018 <span class="preprocessor">#include "udp.h"</span>
00019 <span class="preprocessor">#include "drv_fpga.h"</span>
00020 <span class="preprocessor">#include "drv_dsw.h"</span>
00021 
<a name="l00022"></a><a class="code" href="udp_8c.html#a0">00022</a> <span class="preprocessor">#define _UDP_C_</span>
00023 <span class="preprocessor"></span>
00024 <span class="preprocessor">#ifndef FIFO_SZ                     // FIFOのサイズ設定</span>
<a name="l00025"></a><a class="code" href="udp_8c.html#a1">00025</a> <span class="preprocessor"></span><span class="preprocessor">#define FIFO_SZ     (8192 * 2)      // 2^nで指定</span>
00026 <span class="preprocessor"></span><span class="comment">//#define FIFO_SZ       2048            // 2^nで指定</span>
00027 <span class="preprocessor">#endif</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#ifndef BUFSZ</span>
<a name="l00029"></a><a class="code" href="udp_8c.html#a2">00029</a> <span class="preprocessor"></span><span class="preprocessor">#define BUFSZ       8192            // 一時バッファサイズ設定</span>
00030 <span class="preprocessor"></span><span class="comment">//#define BUFSZ     1024            // 一時バッファサイズ設定</span>
00031 <span class="preprocessor">#endif</span>
00032 <span class="preprocessor"></span>
<a name="l00033"></a><a class="code" href="udp_8c.html#a3">00033</a> <span class="preprocessor">#define REMOTE_PORT 5700            </span>
00034 <span class="preprocessor"></span>
<a name="l00035"></a><a class="code" href="udp_8c.html#a4">00035</a> <span class="preprocessor"></span><span class="keyword">const</span> T_CTSK <a class="code" href="udp_8c.html#a4">c_udprcv_tsk</a> = { TA_HLNG, NULL, <a class="code" href="udp_8c.html#a18">udprcv_tsk</a>, UDP_TSK_LVL, 512, NULL, <span class="stringliteral">"udprcv_tsk"</span> };
00036 
00037 <span class="comment">// Local Data</span>
00038 <span class="keyword">static</span> UH udprcv_buf[<a class="code" href="udp_8c.html#a2">BUFSZ</a>/2];      
00039 <span class="keyword">static</span> ID rcv_tskid;                
00040 <span class="keyword">static</span> ID udp_cepid;                
00041 <span class="keyword">static</span> ID rxtid;                    
00042 <span class="keyword">static</span> T_IPEP udp_dstaddr;          
00043 <span class="keyword">static</span> <span class="keywordtype">int</span> udprcv_len;              
00044 
<a name="l00045"></a><a class="code" href="structt__buf.html">00045</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structt__buf.html">t_buf</a>{               
<a name="l00046"></a><a class="code" href="structt__buf.html#o3">00046</a>     UH <a class="code" href="structt__buf.html#o3">setp</a>;                        
<a name="l00047"></a><a class="code" href="structt__buf.html#o2">00047</a>     UH <a class="code" href="structt__buf.html#o2">getp</a>;                        
<a name="l00048"></a><a class="code" href="structt__buf.html#o1">00048</a>     UH <a class="code" href="structt__buf.html#o1">cnt</a>;                         
<a name="l00049"></a><a class="code" href="structt__buf.html#o0">00049</a>     UB <a class="code" href="structt__buf.html#o0">buf</a>[<a class="code" href="udp_8c.html#a1">FIFO_SZ</a>];                
00050 }<a class="code" href="structt__buf.html">T_BUF</a>;
00051 
00052 <span class="keyword">static</span> <a class="code" href="structt__buf.html">T_BUF</a> udprcv;                
00053 
00054 <span class="keyword">extern</span> UB <a class="code" href="udp_8c.html#a13">default_ipaddr</a>[];         <span class="comment">// IPアドレス               </span>
00055 
00056 <span class="comment">// プロトタイプ宣言</span>
00057 <span class="keyword">static</span> <span class="keywordtype">void</span> init_buf(<span class="keywordtype">void</span>);         <span class="comment">// 受信バッファの初期化</span>
00058 <span class="keyword">static</span> ER udprcv_cbk(ID, FN, VP);   <span class="comment">// 受信コールバック関数</span>
00059 <span class="keyword">static</span> <span class="keywordtype">void</span> put_rxbuf(<span class="keywordtype">void</span>);        <span class="comment">// 受信バッファへの書込み</span>
00060 <span class="keyword">static</span> <span class="keywordtype">int</span> get_rxbuf(UB*);          <span class="comment">// 受信バッファからの取得</span>
00061 
00062 <span class="comment">/*==========================================================================*/</span>
00063 <span class="comment">/* UDP受信バッファクリア                                                    */</span>
00064 <span class="comment">/*==========================================================================*/</span>
00065 
00066 <span class="keyword">static</span> <span class="keywordtype">void</span> init_buf(<span class="keywordtype">void</span>)
00067 {
00068     memset( &amp;udprcv, 0, <span class="keyword">sizeof</span> udprcv);
00069 }
00070 
00071 <span class="comment">/*==========================================================================*/</span>
00072 <span class="comment">/* UDP Server Callback                                                      */</span>
00073 <span class="comment">/*==========================================================================*/</span>
00074 
00075 <span class="keyword">static</span> ER udprcv_cbk(ID cepid, FN fncd, VP parblk)
00076 {
00077     <span class="keywordflow">switch</span>(fncd)
00078     {
00079     <span class="keywordflow">case</span> TFN_UDP_RCV_DAT:
00080         <span class="keywordflow">break</span>;
00081     <span class="keywordflow">case</span> TEV_UDP_RCV_DAT:
00082         udprcv_len = udp_rcv_dat(cepid, &amp;udp_dstaddr, udprcv_buf, <span class="keyword">sizeof</span> udprcv_buf, TMO_POL);
00083         put_rxbuf();                    <span class="comment">// 割込み中で処理するように変更</span>
00084         wup_tsk(rcv_tskid);
00085         <span class="keywordflow">break</span>;
00086     }
00087     <span class="keywordflow">return</span> E_OK;
00088 }
00089 
00090 <span class="comment">/*==========================================================================*/</span>
00095 <span class="comment">/*==========================================================================*/</span>
00096 
<a name="l00097"></a><a class="code" href="udp_8c.html#a18">00097</a> TASK <a class="code" href="udp_8c.html#a18">udprcv_tsk</a>(ID cepid)
00098 {
00099     ID id;
00100     
00101     rcv_tskid = vget_tid();
00102     udp_cepid = cepid;
00103 
00104     <span class="keywordflow">for</span> (;;)
00105     {
00106         <span class="comment">/* Waiting for receive udp echo packet */</span>
00107         <span class="comment">/* It weke uped from udpecho_cbk */</span>
00108         memset(udprcv_buf, 0, <span class="keyword">sizeof</span>(udprcv_buf));
00109         slp_tsk();
00110         
00111 <span class="comment">//      put_rxbuf();</span>
00112         
00113         <span class="comment">// 受信待ち解除</span>
00114         <span class="keywordflow">if</span>((<span class="keywordtype">id</span> = rxtid) != 0) {
00115             rxtid = 0;
00116             wup_tsk((ID)<span class="keywordtype">id</span>);
00117         }
00118     }
00119 }
00120 
00121 <span class="comment">/*==========================================================================*/</span>
00122 <span class="comment">/* 受信バッファへ受信文字/ステータス格納（内部関数）                        */</span>
00123 <span class="comment">/*==========================================================================*/</span>
00124 
00125 <span class="keyword">static</span> <span class="keywordtype">void</span> put_rxbuf(<span class="keywordtype">void</span>)
00126 {
00127     UB *p;
00128     <span class="keywordtype">int</span> ln;
00129 
00130     p  = (UB*)udprcv_buf;   
00131     ln = udprcv_len;
00132     
00133     <span class="keywordflow">while</span>( ln) {
00134         <span class="comment">// バッファ満杯チェック</span>
00135         <span class="keywordflow">if</span> (udprcv.<a class="code" href="structt__buf.html#o1">cnt</a> == FIFO_SZ)
00136             return;
00137         
00138         <span class="comment">// バッファへ格納</span>
00139         udprcv.buf[udprcv.setp] = *p;       <span class="comment">// バッファへ格納</span>
00140         udprcv.cnt++;                       <span class="comment">// バッファデータ数＋１</span>
00141         p++;                                <span class="comment">// ポインタインクリメント</span>
00142         
00143         <span class="comment">// 格納ポインタを１つ進める</span>
00144         udprcv.setp = (++udprcv.setp) &amp; (FIFO_SZ - 1);
00145         
00146         ln--;
00147     }
00148 }
00149 
00150 <span class="comment">/*==========================================================================*/</span>
00151 <span class="comment">/* 受信バッファから１文字取得（内部関数）                                   */</span>
00152 <span class="comment">/*                                                                          */</span>
00153 <span class="comment">/* バッファ空で取得できなかった場合は、-1 を返す。                          */</span>
00154 <span class="comment">/*==========================================================================*/</span>
00155 
00156 static <span class="keywordtype">int</span> get_rxbuf(UB *c)
00157 {
00158     <span class="keywordtype">int</span> cnt;
00159 
00160     <span class="comment">// 受信バッファ空チェック</span>
00161     cnt = udprcv.<a class="code" href="structt__buf.html#o1">cnt</a>;
00162     <span class="keywordflow">if</span> (--cnt == -1)
00163         return cnt;
00164 
00165     udprcv.cnt = (UH)cnt;               <span class="comment">// 受信バッファ内データ数-1</span>
00166     *c = udprcv.buf[ udprcv.getp ];     <span class="comment">// 受信バッファから取得</span>
00167 
00168     <span class="comment">// 取得ポインタを１つ進める</span>
00169     udprcv.getp = (++udprcv.getp) &amp; (FIFO_SZ - 1);
00170 
00171     return 0;
00172 }
00173 
00174 <span class="comment">/*==========================================================================*/</span>
00180 <span class="comment">/*==========================================================================*/</span>
00181 
<a name="l00182"></a><a class="code" href="udp_8c.html#a19">00182</a> <span class="keywordtype">void</span> put_udp(UB *s, UH n)
00183 {
00184     ER ercd;
00185     
00186     udp_dstaddr.portno = <a class="code" href="udp_8c.html#a3">REMOTE_PORT</a>;
00187 
00188     ercd = udp_snd_dat(udp_cepid, &amp;udp_dstaddr, s, n, TMO_FEVR);
00189 }
00190 
00191 <span class="comment">/*==========================================================================*/</span>
00199 <span class="comment">/*==========================================================================*/</span>
00200 
<a name="l00201"></a><a class="code" href="udp_8c.html#a20">00201</a> ER <a class="code" href="udp_8c.html#a20">get_udp</a>(UB *c, TMO tmout)
00202 {
00203     ER ercd;
00204     <span class="keywordtype">int</span> sts;
00205 
00206     <span class="keywordflow">for</span> (;;)
00207     {
00208         <span class="comment">// 受信バッファから１文字得る</span>
00209         sts = get_rxbuf(c);
00210         <span class="keywordflow">if</span> (sts != -1) {            <span class="comment">// 受信データあった場合</span>
00211             ercd = E_OK;
00212             <span class="keywordflow">return</span> ercd;
00213         }
00214 
00215         <span class="comment">// 受信割込み待ち</span>
00216         rxtid = vget_tid();
00217         ercd = tslp_tsk(tmout);
00218         rxtid = 0;
00219         vcan_wup();                 <span class="comment">// 複数回 wup_tsk された場合の対策</span>
00220         <span class="keywordflow">if</span> (ercd)
00221             <span class="keywordflow">return</span> ercd;            <span class="comment">// タイムアウト終了</span>
00222     }
00223 }
00224 
00225 <span class="comment">/*==========================================================================*/</span>
00226 <span class="comment">/* UDP 受信タスク Uninitialize                                              */</span>
00227 <span class="comment">/*==========================================================================*/</span>
00228 
<a name="l00229"></a><a class="code" href="udp_8c.html#a21">00229</a> <span class="keywordtype">void</span> <a class="code" href="udp_8c.html#a21">udp_ext</a>(<span class="keywordtype">void</span>)
00230 {
00231     udp_can_cep(udp_cepid, TFN_TCP_ALL);
00232     udp_del_cep(udp_cepid);
00233     ter_tsk(rcv_tskid);
00234     del_tsk(rcv_tskid);
00235     rcv_tskid = udp_cepid = 0;
00236 }
00237 
00238 <span class="comment">/*==========================================================================*/</span>
00246 <span class="comment">/*==========================================================================*/</span>
00247 
<a name="l00248"></a><a class="code" href="udp_8c.html#a22">00248</a> ER <a class="code" href="udp_8c.html#a22">udp_ini</a>(ID tskid, ID cepid, UH portno)
00249 {
00250     ER ercd;
00251     <span class="keyword">static</span> T_UDP_CCEP c_udp_cep;
00252 
00253     <span class="comment">// UDP通信設定</span>
00254     c_udp_cep.cepatr = 0;                       <span class="comment">// UDP通信端点属性(0)</span>
00255     c_udp_cep.myaddr.ipaddr = IPV4_ADDRANY;     <span class="comment">// 自分側のIPアドレス</span>
00256     c_udp_cep.myaddr.portno = portno;           <span class="comment">// UDPのポート番号</span>
00257     c_udp_cep.callback = (FP)udprcv_cbk;        <span class="comment">// コールバック関数の登録</span>
00258 
00259     <span class="comment">// 受信バッファ初期化</span>
00260     init_buf();
00261 
00262     <span class="comment">// Create UDP Recieve Task</span>
00263     <span class="keywordflow">if</span>(tskid == 0){<span class="comment">/* ID auto (Add by Y.Y) */</span>
00264         ercd = acre_tsk(&amp;<a class="code" href="udp_8c.html#a4">c_udprcv_tsk</a>);
00265         <span class="keywordflow">if</span> (ercd &lt; 0)
00266             <span class="keywordflow">return</span> ercd;
00267         tskid = ercd;
00268     }
00269     <span class="keywordflow">else</span>{
00270         ercd = cre_tsk(tskid, &amp;<a class="code" href="udp_8c.html#a4">c_udprcv_tsk</a>);
00271         <span class="keywordflow">if</span> (ercd != E_OK)
00272             <span class="keywordflow">return</span> ercd;
00273     }
00274 
00275     <span class="comment">// Create UDP Commnunication End Point</span>
00276     <span class="keywordflow">if</span>(cepid == 0)
00277     {   ercd = cepid = udp_vcre_cep(&amp;c_udp_cep);
00278         <span class="keywordflow">if</span>(cepid &lt;= 0)
00279             <span class="keywordflow">goto</span> ERR;
00280     }
00281     <span class="keywordflow">else</span>
00282     {   ercd = udp_cre_cep(cepid, &amp;c_udp_cep);
00283         <span class="keywordflow">if</span> (ercd != E_OK)
00284             <span class="keywordflow">goto</span> ERR;
00285     }
00286 
00287     ercd = udp_set_opt(cepid, SET_UDP_RPKT_OPT, (VP)TRUE, <span class="keyword">sizeof</span>(BOOL));
00288     <span class="keywordflow">if</span> (ercd != E_OK) {
00289         <span class="keywordflow">goto</span> ERR;
00290     }
00291 
00292     <span class="comment">// Start Receive Server Task</span>
00293     ercd = sta_tsk(tskid, cepid);
00294     <span class="keywordflow">if</span> (ercd != E_OK)
00295         <span class="keywordflow">goto</span> ERR;
00296 
00297     <span class="keywordflow">return</span> E_OK;
00298 
00299 ERR:
00300     udp_del_cep(cepid);
00301     del_tsk(tskid);
00302     <span class="keywordflow">return</span> ercd;
00303 
00304 }
00305 
00306 <span class="comment">/* end */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri Sep 7 16:43:24 2012 for VA-300ドライバ by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.1 </small></address>
</body>
</html>
