<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=Shift_JIS">
<title>VA-300ドライバ: drv_led.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">src</a>&nbsp;/&nbsp;<a class="el" href="dir_000001.html">driver</a></div>
<h1>drv_led.c</h1><a href="drv__led_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
<a name="l00013"></a><a class="code" href="drv__led_8c.html#a0">00013</a> <span class="preprocessor">#define _DRV_LED_C_</span>
00014 <span class="preprocessor"></span><span class="preprocessor">#include "kernel.h"</span>
00015 <span class="preprocessor">#include "sh7750.h"</span>
00016 <span class="preprocessor">#include "drv_led.h"</span>
00017 
00018 <span class="comment">// マクロ定義</span>
<a name="l00019"></a><a class="code" href="drv__led_8c.html#a1">00019</a> <span class="preprocessor">#define led_out(n)  sfr_outw(BSC_PDTRA, n)  </span>
00020 <span class="preprocessor"></span>
00021 <span class="preprocessor"></span><span class="comment">// ローカル変数</span>
00022 <span class="keyword">static</span> UH s_uhLedStatus;                <span class="comment">// 状態保持用変数</span>
00023 <span class="keyword">static</span> <span class="keyword">const</span> UH s_uhLedList[] = {
00024     LED_ERR,                            
00025     LED_OK,                             
00026 
00027 };
00028 <span class="keyword">static</span> <span class="keyword">const</span> UH s_nLedList = <span class="keyword">sizeof</span> s_uhLedList / <span class="keyword">sizeof</span> s_uhLedList[ 0 ];
00029 <span class="keyword">static</span> ID s_idSem;                      
00030 
<a name="l00031"></a><a class="code" href="drv__led_8c.html#a6">00031</a> <span class="keyword">const</span> T_CSEM <a class="code" href="drv__led_8c.html#a6">csem_led</a> = { TA_TFIFO, 1, 1, (B *)<span class="stringliteral">"sem_led"</span> };
00032 
00033 <span class="comment">// プロトタイプ宣言</span>
00034 <span class="keyword">static</span> <span class="keywordtype">void</span> ledOut(<span class="keywordtype">int</span> SelectLed, <span class="keywordtype">int</span> OnOff);   
00035 
00036 <span class="comment">/*==========================================================================*/</span>
00043 <span class="comment">/*==========================================================================*/</span>
<a name="l00044"></a><a class="code" href="drv__led_8c.html#a8">00044</a> ER <a class="code" href="drv__led_8c.html#a8">LedInit</a>(ID idSem)
00045 {
00046     ER ercd;
00047 
00048     s_uhLedStatus = 0;
00049     s_idSem = 0;
00050     ercd = cre_sem(idSem, &amp;<a class="code" href="drv__led_8c.html#a6">csem_led</a>);   <span class="comment">// Create semaphore</span>
00051     
00052     <span class="keywordflow">if</span> (ercd == E_OK) {
00053         s_idSem = idSem;
00054         ercd = <a class="code" href="drv__led_8c.html#a9">LedOut</a>(LED_ALL, LED_OFF);<span class="comment">// LED OFF</span>
00055     }
00056     
00057     <span class="keywordflow">return</span> ercd;
00058 }
00059 
00060 <span class="comment">/*==========================================================================*/</span>
00068 <span class="comment">/*==========================================================================*/</span>
<a name="l00069"></a><a class="code" href="drv__led_8c.html#a9">00069</a> ER <a class="code" href="drv__led_8c.html#a9">LedOut</a>(<span class="keywordtype">int</span> SelectLed, <span class="keywordtype">int</span> OnOff)
00070 {
00071     ER  ercd;
00072     
00073     ercd = twai_sem(s_idSem, (10/MSEC));
00074     <span class="keywordflow">if</span> (ercd == E_OK) {
00075         ledOut(SelectLed, OnOff);
00076     } <span class="keywordflow">else</span> {                                <span class="comment">// セマフォ獲得失敗のとき</span>
00077         <span class="keywordflow">return</span> ercd;
00078     }
00079 
00080     <span class="keywordflow">if</span> (sig_sem(s_idSem) != E_OK) {         <span class="comment">// ここでエラーがでるのは設計ミス</span>
00081         <span class="keywordflow">return</span> E_SYS;                       <span class="comment">// エラー</span>
00082     }
00083     
00084     <span class="keywordflow">return</span> ercd;
00085 }
00086 
00087 <span class="comment">/*==========================================================================*/</span>
00095 <span class="comment">/*==========================================================================*/</span>
00096 <span class="keyword">static</span> <span class="keywordtype">void</span> ledOut(<span class="keywordtype">int</span> SelectLed, <span class="keywordtype">int</span> OnOff)
00097 {
00098     <span class="keywordtype">int</span> i;
00099     UH  uhLed;
00100     
00101     <span class="keywordflow">for</span> (i = 0;i &lt; s_nLedList;i++) {
00102         uhLed = s_uhLedList[ i ];
00103         <span class="keywordflow">if</span> (SelectLed &amp; uhLed) {
00104             <span class="keywordflow">if</span> (OnOff == LED_ON) {
00105                 s_uhLedStatus &amp;= ~uhLed;<span class="comment">// Lowで点灯</span>
00106             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (OnOff == LED_REVERSE){
00107                 s_uhLedStatus ^= uhLed;
00108             } <span class="keywordflow">else</span> {
00109                 s_uhLedStatus |= uhLed;
00110             }
00111         }
00112     }
00113     s_uhLedStatus &amp;= LED_ALL;
00114     <a class="code" href="drv__led_8c.html#a1">led_out</a>(s_uhLedStatus);             <span class="comment">// LED出力</span>
00115 }
00116 
00117 <span class="comment">/*==========================================================================*/</span>
00125 <span class="comment">/*==========================================================================*/</span>
<a name="l00126"></a><a class="code" href="drv__led_8c.html#a10">00126</a> <span class="keywordtype">int</span> <a class="code" href="drv__led_8c.html#a10">LedGetStatus</a>(<span class="keywordtype">int</span> SelectLed)
00127 {
00128     <span class="keywordtype">int</span> iStatus;
00129     <span class="keywordtype">int</span> i;
00130     UH  uhLed;
00131 
00132     iStatus = -1;                       <span class="comment">// パラメータエラーにしておく</span>
00133     <span class="keywordflow">for</span> (i = 0;i &lt; s_nLedList;i++) {
00134         uhLed = s_uhLedList[ i ];
00135         <span class="keywordflow">if</span> (SelectLed == uhLed) {
00136             iStatus = LED_OFF;
00137             <span class="keywordflow">if</span> (!(s_uhLedStatus &amp; uhLed)) {
00138                 iStatus = LED_ON;
00139             }
00140             <span class="keywordflow">break</span>;
00141         }
00142     }
00143     
00144     <span class="keywordflow">return</span> iStatus;
00145 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri Sep 7 16:43:24 2012 for VA-300ドライバ by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.1 </small></address>
</body>
</html>
