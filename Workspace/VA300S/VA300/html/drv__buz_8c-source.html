<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=Shift_JIS">
<title>VA-300ドライバ: drv_buz.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">src</a>&nbsp;/&nbsp;<a class="el" href="dir_000001.html">driver</a></div>
<h1>drv_buz.c</h1><a href="drv__buz_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
<a name="l00013"></a><a class="code" href="drv__buz_8c.html#a0">00013</a> <span class="preprocessor">#define _DRV_BUZ_C_</span>
00014 <span class="preprocessor"></span><span class="preprocessor">#include &lt;mathf.h&gt;</span>
00015 <span class="preprocessor">#include "kernel.h"</span>
00016 <span class="preprocessor">#include "sh7750.h"</span>
00017 <span class="preprocessor">#include "drv_buz.h"</span>
00018 
00019 <span class="comment">// 定義</span>
<a name="l00020"></a><a class="code" href="drv__buz_8c.html#a1">00020</a> <span class="preprocessor">#define FREQ_MIN    50.0                // 最小周波数</span>
<a name="l00021"></a><a class="code" href="drv__buz_8c.html#a2">00021</a> <span class="preprocessor"></span><span class="preprocessor">#define FREQ_MAX    48000.0             // 最大周波数</span>
00022 <span class="preprocessor"></span>
00023 <span class="comment">// ローカル変数</span>
00024 <span class="keyword">static</span> ID s_idSem;                      <span class="comment">// セマフォID</span>
00025 
<a name="l00026"></a><a class="code" href="drv__buz_8c.html#a4">00026</a> <span class="keyword">const</span> T_CSEM <a class="code" href="drv__buz_8c.html#a4">csem_buz</a>  = { TA_TFIFO, 1, 1, (B *)<span class="stringliteral">"sem_buz"</span> };
00027     <span class="comment">// 音階と周波数リスト(デモ機から引用)</span>
<a name="l00028"></a><a class="code" href="drv__buz_8c.html#a5">00028</a> <span class="keyword">const</span> <span class="keywordtype">float</span> <a class="code" href="drv__buz_8c.html#a5">buzfrq</a>[] = { 
00029     261.5,  
00030     277.0,  
00031     293.5,  
00032     311.0,  
00033     329.5,  
00034     349.0,  
00035     369.5,  
00036     391.5,  
00037     415.0,  
00038     440.0,  
00039     466.0,  
00040     494.0,  
00041     523.0,
00042     554.0,
00043     587.0,
00044     662.0
00045 };
00046 
00047 <span class="comment">// プロトタイプ宣言</span>
00048 <span class="keyword">static</span> <span class="keywordtype">void</span> buzzerSet(<span class="keywordtype">int</span> iScale, <span class="keyword">enum</span> BUZ_CTRL eCtrl); 
00049 <span class="keyword">static</span> <span class="keywordtype">float</span> freqCalc(<span class="keywordtype">int</span> iScale);                      
00050 
00051 <span class="comment">/*==========================================================================*/</span>
00056 <span class="comment">/*==========================================================================*/</span>
<a name="l00057"></a><a class="code" href="drv__buz_8c.html#a8">00057</a> <span class="keywordtype">void</span> <a class="code" href="drv__buz_8c.html#a8">BuzzerInit</a>(ID <span class="keywordtype">id</span>)
00058 {
00059     ER ercd; 
00060 
00061     s_idSem = 0;
00062     
00063     <span class="comment">// セマフォの生成</span>
00064     <span class="keywordflow">if</span> (<span class="keywordtype">id</span> &gt; 0) {
00065         ercd = cre_sem(<span class="keywordtype">id</span>, &amp;<a class="code" href="drv__buz_8c.html#a4">csem_buz</a>);  
00066         <span class="keywordflow">if</span> (ercd == E_OK) {
00067             s_idSem = id;
00068         }
00069     } <span class="keywordflow">else</span> {
00070         ercd = acre_sem(&amp;<a class="code" href="drv__buz_8c.html#a4">csem_buz</a>);
00071         <span class="keywordflow">if</span> (ercd &gt; 0) {
00072             s_idSem = ercd;
00073         }
00074     }
00075     
00076     <a class="code" href="drv__buz_8c.html#a9">BuzzerSet</a>(0, BUZ_OFF);              <span class="comment">// ブザーOFF</span>
00077 }
00078 
00079 <span class="comment">/*==========================================================================*/</span>
00087 <span class="comment">/*==========================================================================*/</span>
<a name="l00088"></a><a class="code" href="drv__buz_8c.html#a9">00088</a> ER <a class="code" href="drv__buz_8c.html#a9">BuzzerSet</a>(<span class="keywordtype">int</span> iScale, <span class="keyword">enum</span> BUZ_CTRL eCtrl)
00089 {
00090     ER ercd;
00091     
00092     ercd = twai_sem(s_idSem, (100/MSEC));
00093     <span class="keywordflow">if</span> (ercd != E_OK) {
00094         <span class="keywordflow">return</span> ercd;
00095     }
00096     buzzerSet(iScale, eCtrl);
00097         
00098     ercd = sig_sem(s_idSem);
00099     
00100     <span class="keywordflow">return</span> ercd;
00101 }
00102 
00103 <span class="comment">/*==========================================================================*/</span>
00110 <span class="comment">/*==========================================================================*/</span>
00111 <span class="keyword">static</span> <span class="keywordtype">void</span> buzzerSet(<span class="keywordtype">int</span> iScale, <span class="keyword">enum</span> BUZ_CTRL eCtrl)
00112 {
00113     <span class="keywordtype">float</span> fFreq;
00114     
00115     fFreq = 0.0;
00116     
00117     <span class="keywordflow">if</span> (eCtrl == BUZ_ON) {
00118         <span class="comment">// 設定周波数算出</span>
00119         fFreq = freqCalc(iScale);
00120         <span class="comment">// FPGAのレジスタに設定</span>
00121     
00122     } <span class="keywordflow">else</span> {
00123         <span class="comment">// 停止設定</span>
00124         <span class="comment">// FPGAのレジスタに設定</span>
00125         
00126     }
00127 }
00128 
00132 <span class="keyword">static</span> <span class="keywordtype">float</span> freqCalc(<span class="keywordtype">int</span> iScale)
00133 {
00134     <span class="keywordtype">float</span> fFreq;
00135     
00136     fFreq = ldexpf(buzfrq[ iScale &amp; 0xF ] , ((iScale &gt;&gt; 4) &amp; 0xF) - 7); <span class="comment">// The new period or frequency</span>
00137         
00138     <span class="comment">// 周波数範囲を一定の範囲でカット</span>
00139     <span class="keywordflow">if</span> (fFreq &lt; FREQ_MIN) {
00140         fFreq = <a class="code" href="drv__buz_8c.html#a1">FREQ_MIN</a>;
00141     }
00142     <span class="keywordflow">if</span> (fFreq &gt; FREQ_MAX) {
00143         fFreq = <a class="code" href="drv__buz_8c.html#a2">FREQ_MAX</a>;
00144     }
00145 
00146     <span class="keywordflow">return</span> fFreq;
00147 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri Sep 7 16:43:24 2012 for VA-300ドライバ by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.1 </small></address>
</body>
</html>
