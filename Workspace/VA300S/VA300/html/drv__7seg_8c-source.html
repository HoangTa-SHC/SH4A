<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=Shift_JIS">
<title>VA-300ドライバ: drv_7seg.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">src</a>&nbsp;/&nbsp;<a class="el" href="dir_000001.html">driver</a></div>
<h1>drv_7seg.c</h1><a href="drv__7seg_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 
<a name="l00013"></a><a class="code" href="drv__7seg_8c.html#a0">00013</a> <span class="preprocessor">#define _DRV_7SEG_C_</span>
00014 <span class="preprocessor"></span><span class="preprocessor">#include &lt;string.h&gt;</span>
00015 <span class="preprocessor">#include "kernel.h"</span>
00016 <span class="preprocessor">#include "drv_7seg.h"</span>
00017 
00018 <span class="comment">// マクロ定義</span>
<a name="l00019"></a><a class="code" href="drv__7seg_8c.html#a1">00019</a> <span class="preprocessor">#define seg_out(n,v)    fpga_outw((IO_SEG + (n &amp; 0xFE)), v) </span>
<a name="l00020"></a><a class="code" href="drv__7seg_8c.html#a2">00020</a> <span class="preprocessor">#define seg_in(n)       fpga_in((IO_SEG + (n &amp; 0xFE)))      </span>
00021 <span class="preprocessor"></span>
00022 <span class="preprocessor"></span><span class="comment">// ローカル変数</span>
00023 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> SegStatus[ LED_7SEG_MAX ];             
00024 <span class="keyword">static</span> ID s_idSem;                                          
00025 
<a name="l00026"></a><a class="code" href="drv__7seg_8c.html#a5">00026</a> <span class="keyword">const</span> T_CSEM <a class="code" href="drv__7seg_8c.html#a5">csem_seg</a> = { TA_TFIFO, 1, 1, (B *)<span class="stringliteral">"sem_7seg"</span> };
00027 
00028 <span class="comment">// プロトタイプ宣言</span>
00029 <span class="keyword">static</span> BOOL SegOut(<span class="keyword">enum</span> LED_7SEG_SEL SelectSeg, <span class="keywordtype">int</span> Value); 
00030 
00031 <span class="comment">/*==========================================================================*/</span>
00038 <span class="comment">/*==========================================================================*/</span>
<a name="l00039"></a><a class="code" href="drv__7seg_8c.html#a7">00039</a> ER <a class="code" href="drv__7seg_8c.html#a7">Led7SegInit</a>(ID idSem)
00040 {
00041     ER ercd;
00042 
00043     memset(SegStatus, 0, <span class="keyword">sizeof</span>(SegStatus));
00044     s_idSem = 0;
00045 
00046     ercd = cre_sem(idSem, &amp;<a class="code" href="drv__7seg_8c.html#a5">csem_seg</a>);   <span class="comment">// Create semaphore</span>
00047     <span class="keywordflow">if</span> (ercd == E_OK) {
00048         s_idSem = idSem;
00049         ercd = <a class="code" href="drv__7seg_8c.html#a8">Led7SegOut</a>(LED_7SEG_ALL, 0); <span class="comment">// 7Seg初期化</span>
00050     }
00051     
00052     <span class="keywordflow">return</span> ercd;
00053 }
00054 
00055 <span class="comment">/*==========================================================================*/</span>
00063 <span class="comment">/*==========================================================================*/</span>
<a name="l00064"></a><a class="code" href="drv__7seg_8c.html#a8">00064</a> ER <a class="code" href="drv__7seg_8c.html#a8">Led7SegOut</a>(<span class="keyword">enum</span> LED_7SEG_SEL eSelectSeg, <span class="keywordtype">int</span> Value)
00065 {
00066     ER  ercd;
00067     
00068     ercd = twai_sem(s_idSem, (10/MSEC));
00069     <span class="keywordflow">if</span> (ercd == E_OK) {
00070         <span class="keywordflow">if</span> ( SegOut(eSelectSeg, Value) == FALSE) {
00071             ercd = E_PAR;               <span class="comment">// パラメータエラー</span>
00072         }
00073     } <span class="keywordflow">else</span> {                            <span class="comment">// セマフォ獲得失敗のとき</span>
00074         <span class="keywordflow">return</span> ercd;
00075     }
00076     <span class="keywordflow">if</span> (sig_sem(s_idSem) != E_OK) { <span class="comment">// ここでエラーがでるのは設計ミス</span>
00077         <span class="keywordflow">return</span> E_SYS;                   <span class="comment">// エラー</span>
00078     }
00079     <span class="keywordflow">return</span> ercd;
00080 }
00081 
00082 <span class="comment">/*==========================================================================*/</span>
00083 <span class="comment">/* 7SegLEDの出力                                                            */</span>
00084 <span class="comment">/*==========================================================================*/</span>
00085 <span class="keyword">static</span> BOOL SegOut(<span class="keyword">enum</span> LED_7SEG_SEL eSelectSeg, <span class="keywordtype">int</span> Value)
00086 {
00087     <span class="keywordtype">int</span> i, iSelSeg;
00088     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> usOut;
00089     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> usReg;
00090 
00091     <span class="keywordflow">if</span> (eSelectSeg == LED_7SEG_ALL) {
00092         <span class="keywordflow">for</span>( i = LED_7SEG_MIN;i &lt;= LED_7SEG_MAX;i++) {
00093             SegOut( i, Value);
00094         }
00095     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (eSelectSeg &gt;= LED_7SEG_MIN &amp;&amp; eSelectSeg &lt;= LED_7SEG_MAX) {
00096         <span class="keywordflow">if</span> ((Value &amp; ~SEG_PTN_DOT) &gt;= s_nSegPtn) {
00097             <span class="keywordflow">return</span> FALSE;
00098         }
00099         iSelSeg = (int)(eSelectSeg - LED_7SEG_1);
00100         SegStatus[ iSelSeg ] = Value;                       <span class="comment">// 保存変数に値を格納</span>
00101         <span class="keywordflow">if</span> ((SegStatus[ iSelSeg ] &amp; ~SEG_PTN_DOT) &lt; s_nSegPtn) {
00102             usOut = s_SegPtn[ (SegStatus[ iSelSeg ]) ];     <span class="comment">// 出力パターンがあれば設定</span>
00103             <span class="keywordflow">if</span> (SegStatus[ iSelSeg ] &amp; SEG_PTN_DOT) {       <span class="comment">// '.'表示あれば設定</span>
00104                 usOut |= SEG_PTN_DOT;
00105             }
00106             <span class="comment">// 現在のレジスタ値を読込み</span>
00107             usReg = <a class="code" href="drv__7seg_8c.html#a2">seg_in</a>( iSelSeg ); 
00108             <span class="keywordflow">if</span> (iSelSeg % 2) {
00109                 usReg &amp;= 0x00FF;
00110                 usReg |= (<span class="keywordtype">unsigned</span> short)usOut &lt;&lt; 8;
00111             } <span class="keywordflow">else</span> {
00112                 usReg &amp;= 0xFF00;
00113                 usReg |= (<span class="keywordtype">unsigned</span> short)usOut;
00114             }
00115             <span class="comment">// 7SEG出力</span>
00116             <a class="code" href="drv__7seg_8c.html#a1">seg_out</a>(iSelSeg, usReg);
00117         }
00118     } <span class="keywordflow">else</span> {
00119         <span class="keywordflow">return</span> FALSE;
00120     }
00121     <span class="keywordflow">return</span> TRUE;
00122 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri Sep 7 16:43:24 2012 for VA-300ドライバ by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.1 </small></address>
</body>
</html>
