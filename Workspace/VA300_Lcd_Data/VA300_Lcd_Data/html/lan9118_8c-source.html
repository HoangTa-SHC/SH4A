<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=Shift_JIS">
<title>VA-300ドライバ: lan9118.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.1 -->
<div class="qindex"><a class="qindex" href="main.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">src</a>&nbsp;/&nbsp;<a class="el" href="dir_000001.html">driver</a>&nbsp;/&nbsp;<a class="el" href="dir_000002.html">net</a></div>
<h1>lan9118.c</h1><a href="lan9118_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*******************************************************************************</span>
00002 <span class="comment">* SMSC LAN9118                                                                 *</span>
00003 <span class="comment">*                                                                              *</span>
00004 <span class="comment">*  Copyright (c) 2005-2010, MiSPO Co., Ltd.                                    *</span>
00005 <span class="comment">*  All rights reserved.                                                        *</span>
00006 <span class="comment">*                                                                              *</span>
00007 <span class="comment">* 2005-04-19 Created                                                        OK *</span>
00008 <span class="comment">* 2005-06-10 Corrected for 16bit-Bus configuration (ENDIAN)                 OK *</span>
00009 <span class="comment">* 2005-06-28 デバイスBug(10Base-T極性反転)対策                              OK *</span>
00010 <span class="comment">* 2005-06-28 受信バッファの処理が遅延されるBug修正(DMAモード時)             OK *</span>
00011 <span class="comment">* 2005-07-11 不要テストコード削除(実コードに変更なし)                       OK *</span>
00012 <span class="comment">* 2005-09-21 LANバッファに非キャッシュ空間を割り当て可能にした              OK *</span>
00013 <span class="comment">* 2006-02-05 割り込み線出力のバッファタイプをマクロ指定可能にした           HM *</span>
00014 <span class="comment">* 2006-05-31 BUFF_ALIGN=16 or 32の場合のチップBug回避コードBug fix          OK *</span>
00015 <span class="comment">* 2006-06-09 マルチチャネル対応の再定義漏れ修正(lan_dma_xxx?)               OK *</span>
00016 <span class="comment">* 2006-10-31 PIO転送でリンク状態遷移により受信異常が起こる問題を修正        HM *</span>
00017 <span class="comment">*            CSR_CMD=0に初期化する(HW-RESETなしに再スタート考慮 for debug)     *</span>
00018 <span class="comment">*            ハンドラ登録をイベントクリア後に移動                              *</span>
00019 <span class="comment">* 2006-11-10 リンクダウンのときの送信タスク起床削除                         HM *</span>
00020 <span class="comment">* 2006-11-27 DMA使用モードでエラー受信あると通信が停止するbugの対策         OK *</span>
00021 <span class="comment">*            リンク監視の方法の再見直し(Upは送受信独立。Downは優先処理)        *</span>
00022 <span class="comment">*            送信側の待ち要因を「lan_wai_snd()」1ケ所に集約する                *</span>
00023 <span class="comment">* 2006-12-13 BigEndian,BUS=16,BUS-SWAP=0でENDIAN_CTL書込み前にRead追加      OK *</span>
00024 <span class="comment">*            (RESET復帰の初回にReadが必用なため)                               *</span>
00025 <span class="comment">* 2006-12-22 半2重のとき自己パケットがループバックする機能を無効にした      HM *</span>
00026 <span class="comment">* 2007-01-11 送信FIFO枯渇と同時の受信用DMA割込みで受信INT許可の遅れ対策     OK *</span>
00027 <span class="comment">* 2007-09-14 BigEndian,DMA転送でのデータ並び替え対応                        YM *</span>
00028 <span class="comment">* 2007-10-12 仮割り当てMACアドレスを変更 0050C2-040FFF → 123456-789ABC     SZ *</span>
00029 <span class="comment">* 2007-10-16 GHS2000 compiler warning corrections.                          SZ *</span>
00030 <span class="comment">* 2009-02-27 リンクダウン時にコントローラに出力せずに破棄(下記関数)      IS,OK *</span>
00031 <span class="comment">*            lan_wai_snd、lan_put_end、lan_link                                *</span>
00032 <span class="comment">* 2010-03-12 Removed unused local variable "delay" in lan_wai_snd           HE *</span>
00033 <span class="comment">*            Replaced NORTi3 header include with NORTi4                        *</span>
00034 <span class="comment">*            Replaced interrupt handler with interrupt service routine         *</span>
00035 <span class="comment">*******************************************************************************/</span>
00036 
00037 <span class="comment">/*</span>
00038 <span class="comment"></span>
00039 <span class="comment">DMA使用の有無</span>
00040 <span class="comment"></span>
00041 <span class="comment">          NO_DMA   = 0: DMA有効                  ..... default</span>
00042 <span class="comment">                     1: DMA無効</span>
00043 <span class="comment"></span>
00044 <span class="comment">          (例) shc &lt;option&gt; -def=NO_DMA=1 lan9118.c</span>
00045 <span class="comment">                            ~~~~~~~~~~~~~</span>
00046 <span class="comment"></span>
00047 <span class="comment">強制ループバックの設定</span>
00048 <span class="comment"></span>
00049 <span class="comment">          LBTYPE   = 0: ループバック禁止(標準)   ..... default</span>
00050 <span class="comment">                     1: 内部ループバック(MAC)</span>
00051 <span class="comment">                     2: 外部ループバック(PHY)</span>
00052 <span class="comment"></span>
00053 <span class="comment">          (例) shc &lt;option&gt; -def=LBTYPE=2 lan9118.c</span>
00054 <span class="comment">                            ~~~~~~~~~~~~~</span>
00055 <span class="comment"></span>
00056 <span class="comment">          注意! ドライバ単体テスト用です「NORTi TCP/IPプロトコルスタック」</span>
00057 <span class="comment">                を使用した上位アプリケーションの実行目的には使用できません。</span>
00058 <span class="comment"></span>
00059 <span class="comment"></span>
00060 <span class="comment">通信モードの設定</span>
00061 <span class="comment"></span>
00062 <span class="comment">          FULLDPLX = 0: AutoNegotiation          ..... default</span>
00063 <span class="comment">                     1:  10M/HALF Duplex mode</span>
00064 <span class="comment">                     2:  10M/FULL Duplex mode</span>
00065 <span class="comment">                     3: 100M/HALF Duplex mode</span>
00066 <span class="comment">                     4: 100M/FULL Duplex mode</span>
00067 <span class="comment"></span>
00068 <span class="comment">          (例) shc &lt;option&gt; -def=FULLDPLX=1 lan9118.c</span>
00069 <span class="comment">                            ~~~~~~~~~~~~~~~</span>
00070 <span class="comment"></span>
00071 <span class="comment">バッファアライメント</span>
00072 <span class="comment"></span>
00073 <span class="comment">          DMA転送が有効な場合でLANバッファメモリにバースト転送モードを持つ</span>
00074 <span class="comment">          デバイス(SDRAMなど)をご使用の場合にその転送サイズ(16 or 32byte)</span>
00075 <span class="comment">          に合わせてください。バースト転送をもたないメモリデバイスや、バー</span>
00076 <span class="comment">          スト転送を行わない場合は、デフォルトでご使用ください。</span>
00077 <span class="comment"></span>
00078 <span class="comment">          BUFF_ALIGN =  4:  4byte alignment      ..... default</span>
00079 <span class="comment">                       16: 16byte alignment</span>
00080 <span class="comment">                       32: 32byte alignment</span>
00081 <span class="comment"></span>
00082 <span class="comment">          (例) shc &lt;option&gt; -def=BUFF_ALIGN=16 lan9118.c</span>
00083 <span class="comment">                            ~~~~~~~~~~~~~~~~~~</span>
00084 <span class="comment"></span>
00085 <span class="comment">          注意! 現バージョンでは、BUFF_ALIGN=32の動作は未確認です。</span>
00086 <span class="comment"></span>
00087 <span class="comment"></span>
00088 <span class="comment">LINK UP監視時間の設定</span>
00089 <span class="comment"></span>
00090 <span class="comment">          LINK DOWN(未接続)の状態からLINK UP(接続)を監視する周期時間を設定</span>
00091 <span class="comment">          します。設定値は、システムコールに指定のタイムアウト値相当です。</span>
00092 <span class="comment">          デフォルトは、1秒です。LINK UP直後の自局送信が最大でこの設定時間</span>
00093 <span class="comment">          遅れます。受信があれば送受信ともに即時復帰します。</span>
00094 <span class="comment"></span>
00095 <span class="comment">          LINK_TIME =</span>
00096 <span class="comment">                     0: 禁止</span>
00097 <span class="comment">                     1: 最小</span>
00098 <span class="comment">             1000/MSEC: 1秒                      ..... default</span>
00099 <span class="comment"></span>
00100 <span class="comment">          ※MSECマクロについては、NORTi ユーザーズガイドを参照ください。</span>
00101 <span class="comment"></span>
00102 <span class="comment"></span>
00103 <span class="comment">マルチキャストフレームの受信</span>
00104 <span class="comment"></span>
00105 <span class="comment">          ALMUL    = 0: 受信しない               ..... default</span>
00106 <span class="comment">                     1: 受信する</span>
00107 <span class="comment"></span>
00108 <span class="comment"></span>
00109 <span class="comment">プロミスキャス受信(到着フレーム全受信)</span>
00110 <span class="comment"></span>
00111 <span class="comment">          PRMS     = 0: 無効                     ..... default</span>
00112 <span class="comment">                     1: 有効</span>
00113 <span class="comment"></span>
00114 <span class="comment">割り込み線出力のバッファタイプ</span>
00115 <span class="comment"></span>
00116 <span class="comment">          IRQ_BUFF = 0: オープンドレイン         ..... default</span>
00117 <span class="comment">                     1: プッシュプル</span>
00118 <span class="comment"></span>
00119 <span class="comment">*/</span>
00120 
00121 <span class="preprocessor">#include &lt;string.h&gt;</span>
00122 <span class="preprocessor">#ifndef NULL</span>
00123 <span class="preprocessor"></span><span class="preprocessor">#include &lt;stdio.h&gt;</span>
00124 <span class="preprocessor">#endif</span>
00125 <span class="preprocessor"></span><span class="preprocessor">#ifdef GAIO</span>
00126 <span class="preprocessor"></span><span class="preprocessor">#include &lt;memory.h&gt;</span>
00127 <span class="preprocessor">#endif</span>
00128 <span class="preprocessor"></span><span class="preprocessor">#include "kernel.h"</span>
00129 <span class="preprocessor">#include "nosys4.h"</span>
00130 <span class="preprocessor">#include "nonet.h"</span>
00131 <span class="preprocessor">#include "nonethw.h"</span>
00132 <span class="preprocessor">#include "lan9118.h"</span>
00133 
00134 <span class="comment">/*</span>
00135 <span class="comment"> * ドライバ機能定義</span>
00136 <span class="comment"> */</span>
00137 
00138 <span class="preprocessor">#ifndef BUG_10BASE_POL</span>
<a name="l00139"></a><a class="code" href="lan9118_8c.html#a0">00139</a> <span class="preprocessor"></span><span class="preprocessor">#define BUG_10BASE_POL  1  </span><span class="comment">/* be workaround */</span>
00140 <span class="preprocessor">#endif</span>
00141 <span class="preprocessor"></span>
00142 <span class="comment">/* DMA使用 */</span>
00143 
00144 <span class="preprocessor">#ifndef NO_DMA</span>
<a name="l00145"></a><a class="code" href="lan9118_8c.html#a1">00145</a> <span class="preprocessor"></span><span class="preprocessor">#define NO_DMA      0   </span><span class="comment">/* default need DMA (0:DMA / 1:no DMA) */</span>
00146 <span class="comment">//#define NO_DMA      1   /* default need DMA (0:DMA / 1:no DMA) */     //Ver106-1</span>
00147 <span class="preprocessor">#endif</span>
00148 <span class="preprocessor"></span>
00149 <span class="preprocessor">#if NO_DMA</span>
00150 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00151"></a><a class="code" href="lan9118_8c.html#a2">00151</a> <span class="preprocessor"></span><span class="preprocessor">#define lan_indrep(a,b)  lan_dma_sta((UW)a,(UW)&amp;lan_ind(RX_DATA),(UW)b)</span>
00152 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00153 <span class="preprocessor"></span>
00154 <span class="comment">/* ループバック */</span>
00155 
00156 <span class="preprocessor">#ifndef LBTYPE</span>
<a name="l00157"></a><a class="code" href="lan9118_8c.html#a3">00157</a> <span class="preprocessor"></span><span class="preprocessor">#define LBTYPE      0   </span><span class="comment">/* ループバック禁止(標準モード) */</span>
00158 <span class="preprocessor">#endif</span>
00159 <span class="preprocessor"></span>
00160 <span class="comment">/* 半二重/全二重 */</span>
00161 
00162 <span class="preprocessor">#if LBTYPE != 0</span>
00163 <span class="preprocessor"></span><span class="preprocessor">#undef FULLDPLX</span>
00164 <span class="preprocessor"></span><span class="preprocessor">#define FULLDPLX    4   </span><span class="comment">/* 100M/FullDuplex if loopback enable */</span>
00165 <span class="preprocessor">#else</span>
00166 <span class="preprocessor"></span><span class="preprocessor">#ifndef FULLDPLX</span>
<a name="l00167"></a><a class="code" href="lan9118_8c.html#a4">00167</a> <span class="preprocessor"></span><span class="preprocessor">#define FULLDPLX    0   </span><span class="comment">/* Auto-Negotiation available */</span>
00168 <span class="preprocessor">#endif</span>
00169 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00170 <span class="preprocessor"></span>
00171 <span class="comment">/* バッファアライメント(this must be 4,16,32) */</span>
00172 
00173 <span class="preprocessor">#if NO_DMA</span>
00174 <span class="preprocessor"></span><span class="preprocessor">#undef  BUFF_ALIGN      </span><span class="comment">/* FIFO PIOアクセスは4に固定 */</span>
00175 <span class="preprocessor">#endif</span>
00176 <span class="preprocessor"></span><span class="preprocessor">#ifndef BUFF_ALIGN</span>
<a name="l00177"></a><a class="code" href="lan9118_8c.html#a5">00177</a> <span class="preprocessor"></span><span class="preprocessor">#define BUFF_ALIGN  4</span>
00178 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00179 <span class="preprocessor"></span>
00180 <span class="comment">/* 非キャッシュ空間オフセット (LANバッファ用変数アドレスに加算します) */</span>
00181 
00182 <span class="preprocessor">#ifndef LAN_BUF_BASE</span>
<a name="l00183"></a><a class="code" href="lan9118_8c.html#a6">00183</a> <span class="preprocessor"></span><span class="preprocessor">#define LAN_BUF_BASE    0        </span><span class="comment">/* no cacheable */</span>
00184 <span class="preprocessor">#endif</span>
00185 <span class="preprocessor"></span>
00186 <span class="comment">/* LINK UP監視時間 */</span>
00187 
00188 <span class="preprocessor">#ifndef LINK_TIME</span>
<a name="l00189"></a><a class="code" href="lan9118_8c.html#a7">00189</a> <span class="preprocessor"></span><span class="preprocessor">#define LINK_TIME   (1000/MSEC)  </span><span class="comment">/* default is 1[sec] period */</span>
00190 <span class="preprocessor">#endif</span>
00191 <span class="preprocessor"></span>
00192 <span class="comment">/* マルチキャストフレームの受信 */</span>
00193 
00194 <span class="preprocessor">#ifndef ALMUL</span>
<a name="l00195"></a><a class="code" href="lan9118_8c.html#a8">00195</a> <span class="preprocessor"></span><span class="preprocessor">#define ALMUL       0     </span><span class="comment">/* 0 = 受信しない, 1 = 全て受信  */</span>
00196 <span class="preprocessor">#endif</span>
00197 <span class="preprocessor"></span>
00198 <span class="comment">/* プロミスキャス受信(到着フレーム全受信) */</span>
00199 
00200 <span class="preprocessor">#ifndef PRMS</span>
<a name="l00201"></a><a class="code" href="lan9118_8c.html#a9">00201</a> <span class="preprocessor"></span><span class="preprocessor">#define PRMS        0     </span><span class="comment">/* 0 = 無効, 1 = 有効 */</span>
00202 <span class="preprocessor">#endif</span>
00203 <span class="preprocessor"></span>
00204 <span class="comment">/* PHYデバイス局アドレス */</span>
00205 
00206 <span class="preprocessor">#ifndef PHYAD</span>
<a name="l00207"></a><a class="code" href="lan9118_8c.html#a10">00207</a> <span class="preprocessor"></span><span class="preprocessor">#define PHYAD       0x01  </span><span class="comment">/* 内蔵は0x01に固定 */</span>
00208 <span class="preprocessor">#endif</span>
00209 <span class="preprocessor"></span>
00210 <span class="comment">/* 割り込み線出力のバッファタイプ */</span>
00211 
00212 <span class="preprocessor">#ifndef IRQ_BUFF</span>
<a name="l00213"></a><a class="code" href="lan9118_8c.html#a11">00213</a> <span class="preprocessor"></span><span class="preprocessor">#define IRQ_BUFF    0     </span><span class="comment">/* 0 = オープンドレイン, 1 = プッシュプル */</span>
00214 <span class="preprocessor">#endif</span>
00215 <span class="preprocessor"></span>
00216 <span class="comment">/*</span>
00217 <span class="comment"> * Buffer Descripter definition</span>
00218 <span class="comment"> */</span>
00219 
<a name="l00220"></a><a class="code" href="structt__bd.html">00220</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structt__bd.html">t_bd</a> {
00221     <span class="keyword">union</span>{
00222         <span class="keyword">struct</span>{
<a name="l00223"></a><a class="code" href="structt__bd.html#o4">00223</a>             UH <a class="code" href="structt__bd.html#o4">ctl</a>;
<a name="l00224"></a><a class="code" href="structt__bd.html#o5">00224</a>             UH <a class="code" href="structt__bd.html#o5">len</a>;
<a name="l00225"></a><a class="code" href="structt__bd.html#o8">00225</a>             UW <a class="code" href="structt__bd.html#o8">stat</a>;
00226         } rx;           <span class="comment">/* Rx CSR */</span>
00227         <span class="keyword">struct </span>{
<a name="l00228"></a><a class="code" href="structt__bd.html#o1">00228</a>             UW <a class="code" href="structt__bd.html#o1">cmd_a</a>;
<a name="l00229"></a><a class="code" href="structt__bd.html#o2">00229</a>             UW <a class="code" href="structt__bd.html#o2">cmd_b</a>;
00230         } tx;           <span class="comment">/* Tx CSR */</span>
00231     } <a class="code" href="structt__bd.html#o3">csr</a>;              <span class="comment">/* Control &amp; Status registration(CSR) */</span>
<a name="l00232"></a><a class="code" href="structt__bd.html#o0">00232</a>     UB *<a class="code" href="structt__bd.html#o0">buf</a>;
<a name="l00233"></a><a class="code" href="structt__bd.html#o6">00233</a>     <span class="keyword">struct </span><a class="code" href="structt__bd.html">t_bd</a> *<a class="code" href="structt__bd.html#o6">next</a>;
00234 } <a class="code" href="structt__bd.html">T_BD</a>;
00235 
<a name="l00236"></a><a class="code" href="lan9118_8c.html#a12">00236</a> <span class="preprocessor">#define BD_SIZE         16          </span><span class="comment">/* BD size number */</span>
00237 
00238 <span class="comment">/* CSR bit field definition */</span>
00239 
<a name="l00240"></a><a class="code" href="lan9118_8c.html#a13">00240</a> <span class="preprocessor">#define RX_BD_RDY       0x8000      </span><span class="comment">/* Rx-BD Ready bit */</span>
00241 
00242 <span class="comment">/* Buffer configuration */</span>
00243 
00244 <span class="preprocessor">#ifndef NUM_RXBDS</span>
<a name="l00245"></a><a class="code" href="lan9118_8c.html#a14">00245</a> <span class="preprocessor"></span><span class="preprocessor">#define NUM_RXBDS       8           </span><span class="comment">/* Rx buffer number */</span>
00246 <span class="preprocessor">#endif</span>
00247 <span class="preprocessor"></span><span class="preprocessor">#ifndef NUM_TXBDS</span>
<a name="l00248"></a><a class="code" href="lan9118_8c.html#a15">00248</a> <span class="preprocessor"></span><span class="preprocessor">#define NUM_TXBDS       1           </span><span class="comment">/* Tx buffer number */</span>
00249 <span class="preprocessor">#endif</span>
00250 <span class="preprocessor"></span>
00251 <span class="preprocessor">#if BUFF_ALIGN == 4</span>
<a name="l00252"></a><a class="code" href="lan9118_8c.html#a16">00252</a> <span class="preprocessor"></span><span class="preprocessor">#define RECV_BUFF_SIZE  1520        </span><span class="comment">/* &gt;= 1514+4(CRC) &amp;&amp; 4-byte align */</span>
<a name="l00253"></a><a class="code" href="lan9118_8c.html#a17">00253</a> <span class="preprocessor">#define SEND_BUFF_SIZE  1516        </span><span class="comment">/* &gt;= 1514        &amp;&amp; 4-byte align */</span>
<a name="l00254"></a><a class="code" href="lan9118_8c.html#a18">00254</a> <span class="preprocessor">#define TX_CMDA_EA      TX_CMDA_EA4 </span><span class="comment">/* TX COMMAND 'A' field */</span>
<a name="l00255"></a><a class="code" href="lan9118_8c.html#a19">00255</a> <span class="preprocessor">#define RCFG_EA         RCFG_EA4    </span><span class="comment">/* RX_CFG register field */</span>
00256 
00257 <span class="preprocessor">#elif BUFF_ALIGN == 16</span>
00258 <span class="preprocessor"></span><span class="preprocessor">#define RECV_BUFF_SIZE  1520        </span><span class="comment">/* &gt;= 1514+4(CRC) &amp;&amp; 16-byte align */</span>
00259 <span class="preprocessor">#define SEND_BUFF_SIZE  1520        </span><span class="comment">/* &gt;= 1514        &amp;&amp; 16-byte align */</span>
00260 <span class="preprocessor">#define TX_CMDA_EA      TX_CMDA_EA16</span><span class="comment">/* TX COMMAND 'A' field */</span>
00261 <span class="preprocessor">#define RCFG_EA         RCFG_EA16   </span><span class="comment">/* RX_CFG register field */</span>
00262 
00263 <span class="preprocessor">#elif BUFF_ALIGN == 32</span>
00264 <span class="preprocessor"></span><span class="preprocessor">#define RECV_BUFF_SIZE  1536        </span><span class="comment">/* &gt;= 1514+4(CRC) &amp;&amp; 32-byte align */</span>
00265 <span class="preprocessor">#define SEND_BUFF_SIZE  1536        </span><span class="comment">/* &gt;= 1514        &amp;&amp; 32-byte align */</span>
00266 <span class="preprocessor">#define TX_CMDA_EA      TX_CMDA_EA32</span><span class="comment">/* TX COMMAND 'A' field */</span>
00267 <span class="preprocessor">#define RCFG_EA         RCFG_EA32   </span><span class="comment">/* RX_CFG register field */</span>
00268 
00269 <span class="preprocessor">#else</span>
00270 <span class="preprocessor"></span><span class="preprocessor">#error "other size is bad."</span>
00271 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00272 <span class="preprocessor"></span>
<a name="l00273"></a><a class="code" href="lan9118_8c.html#a20">00273</a> <span class="preprocessor">#define ETHMINLEN       64          </span><span class="comment">/* Ethernetパケット最小長(FCS含む) */</span>
<a name="l00274"></a><a class="code" href="lan9118_8c.html#a21">00274</a> <span class="preprocessor">#define ETHMAXLEN       1518        </span><span class="comment">/* Ethernetパケット最大長(FCS含む) */</span>
00275 
00276 <span class="keyword">static</span> <a class="code" href="structt__bd.html">T_BD</a> *cRxBD;    <span class="comment">/* Rx BD background address for DMA */</span>
00277 <span class="keyword">static</span> <a class="code" href="structt__bd.html">T_BD</a> *pRxBD;    <span class="comment">/* Rx BD current    address for handling */</span>
00278 <span class="keyword">static</span> <a class="code" href="structt__bd.html">T_BD</a> *pTxBD;    <span class="comment">/* Tx BD current    address for handling */</span>
00279 
00280 <span class="comment">/* Buffer Memory */</span>
00281 
00282 <span class="keyword">static</span> <a class="code" href="structt__bd.html">T_BD</a> RxBD[<a class="code" href="lan9118_8c.html#a14">NUM_RXBDS</a>];  <span class="comment">/* Rx BD area */</span>
00283 <span class="keyword">static</span> <a class="code" href="structt__bd.html">T_BD</a> TxBD[<a class="code" href="lan9118_8c.html#a15">NUM_TXBDS</a>];  <span class="comment">/* Tx BD area */</span>
00284 
00285 <span class="keyword">static</span> UB  RxBuf[<a class="code" href="lan9118_8c.html#a14">NUM_RXBDS</a> * <a class="code" href="lan9118_8c.html#a16">RECV_BUFF_SIZE</a> +<a class="code" href="lan9118_8c.html#a5">BUFF_ALIGN</a>-1];  <span class="comment">/* Rx buffer */</span>
00286 <span class="keyword">static</span> UB  TxBuf[<a class="code" href="lan9118_8c.html#a15">NUM_TXBDS</a> * <a class="code" href="lan9118_8c.html#a17">SEND_BUFF_SIZE</a> +<a class="code" href="lan9118_8c.html#a5">BUFF_ALIGN</a>-1];  <span class="comment">/* Tx buffer */</span>
00287 
00288 
00289 <span class="comment">/* LANコントローラドライバのコールバック関数の型 */</span>
00290 
<a name="l00291"></a><a class="code" href="lan9118_8c.html#a42">00291</a> <span class="keyword">typedef</span> ER (*LAN_CALLBACK)(int, ER, <span class="keyword">const</span> <span class="keywordtype">char</span>*);
00292                                 <span class="comment">/* 第1引数  チャネル番号</span>
00293 <span class="comment">                                   第2引数  リンクステータス</span>
00294 <span class="comment">                                             0: LAN_LNK_OFF  リンク消失</span>
00295 <span class="comment">                                             1: LAN_LNK_10H  リンク復旧(10M半二重)</span>
00296 <span class="comment">                                             2: LAN_LNK_10F  リンク復旧(10M全二重)</span>
00297 <span class="comment">                                             3: LAN_LNK_100H リンク復旧(100M半二重)</span>
00298 <span class="comment">                                             4: LAN_LNK_100F リンク復旧(100M全二重)</span>
00299 <span class="comment">                                   第3引数  エラーメッセージ */</span>
00300 
00301 <span class="comment">/* LANコントローラ制御ブロックの型 */</span>
00302 
<a name="l00303"></a><a class="code" href="structt__lan.html">00303</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structt__lan.html">t_lan</a> {
<a name="l00304"></a><a class="code" href="structt__lan.html#o14">00304</a>     <span class="keyword">volatile</span> UH <a class="code" href="structt__lan.html#o14">txtid</a>;
<a name="l00305"></a><a class="code" href="structt__lan.html#o7">00305</a>     <span class="keyword">volatile</span> UH <a class="code" href="structt__lan.html#o7">rxtid</a>;
<a name="l00306"></a><a class="code" href="structt__lan.html#o0">00306</a>     FP <a class="code" href="structt__lan.html#o0">callback</a>;        <span class="comment">/* コールバック関数のアドレス */</span>
<a name="l00307"></a><a class="code" href="structt__lan.html#o13">00307</a>     UH <a class="code" href="structt__lan.html#o13">txtag</a>;           <span class="comment">/* Tx COMMAND 'B' Tag number */</span>
<a name="l00308"></a><a class="code" href="structt__lan.html#o1">00308</a>     <span class="keyword">volatile</span> UB <a class="code" href="structt__lan.html#o1">lnk_chg</a>;<span class="comment">/* LINK change indication flag */</span>
<a name="l00309"></a><a class="code" href="structt__lan.html#o4">00309</a>     UB <a class="code" href="structt__lan.html#o4">pad</a>[1];
<a name="l00310"></a><a class="code" href="structt__lan.html#o9">00310</a>     ER <a class="code" href="structt__lan.html#o9">sts_new</a>;         <span class="comment">/* LINK状態(current) */</span>
<a name="l00311"></a><a class="code" href="structt__lan.html#o10">00311</a>     ER <a class="code" href="structt__lan.html#o10">sts_old</a>;         <span class="comment">/* LINK状態(previous) */</span>
<a name="l00312"></a><a class="code" href="structt__lan.html#o8">00312</a>     ER <a class="code" href="structt__lan.html#o8">sts_mod</a>;         <span class="comment">/* LINK状態(mode before current) */</span>
<a name="l00313"></a><a class="code" href="structt__lan.html#o3">00313</a>     <span class="keyword">volatile</span> UW <a class="code" href="structt__lan.html#o3">mask</a>;   <span class="comment">/* same as INT_EN register */</span>
<a name="l00314"></a><a class="code" href="structt__lan.html#o2">00314</a>     UW <a class="code" href="structt__lan.html#o2">mac_cr</a>;          <span class="comment">/* same as MAC_CR register */</span>
<a name="l00315"></a><a class="code" href="structt__lan.html#o5">00315</a>     <a class="code" href="structt__bd.html">T_BD</a> *<a class="code" href="structt__lan.html#o5">rxbd</a>;         <span class="comment">/* Rx処理BD */</span>
<a name="l00316"></a><a class="code" href="structt__lan.html#o11">00316</a>     <a class="code" href="structt__bd.html">T_BD</a> *<a class="code" href="structt__lan.html#o11">txbd</a>;         <span class="comment">/* Tx処理BD */</span>
<a name="l00317"></a><a class="code" href="structt__lan.html#o6">00317</a>     UB *<a class="code" href="structt__lan.html#o6">rxbuf</a>;          <span class="comment">/* Rx buffer position */</span>
<a name="l00318"></a><a class="code" href="structt__lan.html#o12">00318</a>     UB *<a class="code" href="structt__lan.html#o12">txbuf</a>;          <span class="comment">/* Tx buffer position */</span>
00319 
00320 <span class="comment">/* for debug */</span>
00321 <span class="preprocessor">#ifdef RX_MONITOR</span>
00322 <span class="preprocessor"></span><span class="preprocessor">#define RMON(a) lan.err_count[a]++;</span>
00323 <span class="preprocessor"></span>
00324 <span class="preprocessor">#define ERR_BDOV      0  </span><span class="comment">/* RX BD overrun */</span>
00325 <span class="preprocessor">#define ERR_DROP      1  </span><span class="comment">/* RX Drop frame */</span>
00326 <span class="preprocessor">#define ERR_RXCNT     2  </span><span class="comment">/* RX frame count */</span>
00327 <span class="preprocessor">#define ERR_ERSTAT    3  </span><span class="comment">/* RX error frame count */</span>
00328 <span class="preprocessor">#define ERR_TOOLG     4  </span><span class="comment">/* RX too long frame length */</span>
00329 <span class="preprocessor">#define ERR_RXINT     5  </span><span class="comment">/* RX INT count */</span>
00330 <span class="preprocessor">#define ERR_LOG_MAX   6</span>
00331 <span class="preprocessor"></span>
00332     UW err_count[ERR_LOG_MAX];
00333 <span class="preprocessor">#else</span>
<a name="l00334"></a><a class="code" href="lan9118_8c.html#a22">00334</a> <span class="preprocessor"></span><span class="preprocessor">#define RMON(a) do{}while(0)</span>
00335 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00336 <span class="preprocessor"></span>} <a class="code" href="structt__lan.html">T_LAN</a>;
00337 
00338 <span class="comment">/* 内部変数 */</span>
00339 
00340 <span class="keyword">static</span> <a class="code" href="structt__lan.html">T_LAN</a> lan;
00341 <span class="keyword">static</span> FP callbackini = 0;
00342 
00343 <span class="keyword">static</span> UH PHY_mode;
00344 <span class="keyword">static</span> UH PHY_auto;
00345 
00346 <span class="comment">/* マルチチャネル使用時の関数名リネーム */</span>
00347 
00348 <span class="preprocessor">#if (defined(DIF_NUM))</span>
00349 <span class="preprocessor"></span><span class="preprocessor">  #if (DIF_NUM == 0)</span>
00350 <span class="preprocessor"></span><span class="preprocessor">    #define lan_ini       lan_ini0</span>
00351 <span class="preprocessor"></span><span class="preprocessor">    #define lan_ini_dev   lan_ini_dev0</span>
00352 <span class="preprocessor"></span><span class="preprocessor">    #define lan_ext_dev   lan_ext_dev0</span>
00353 <span class="preprocessor"></span><span class="preprocessor">    #define lan_wai_rcv   lan_wai_rcv0</span>
00354 <span class="preprocessor"></span><span class="preprocessor">    #define lan_wai_snd   lan_wai_snd0</span>
00355 <span class="preprocessor"></span><span class="preprocessor">    #define lan_get_len   lan_get_len0</span>
00356 <span class="preprocessor"></span><span class="preprocessor">    #define lan_get_pkt   lan_get_pkt0</span>
00357 <span class="preprocessor"></span><span class="preprocessor">    #define lan_skp_pkt   lan_skp_pkt0</span>
00358 <span class="preprocessor"></span><span class="preprocessor">    #define lan_get_end   lan_get_end0</span>
00359 <span class="preprocessor"></span><span class="preprocessor">    #define lan_set_len   lan_set_len0</span>
00360 <span class="preprocessor"></span><span class="preprocessor">    #define lan_put_pkt   lan_put_pkt0</span>
00361 <span class="preprocessor"></span><span class="preprocessor">    #define lan_put_dmy   lan_put_dmy0</span>
00362 <span class="preprocessor"></span><span class="preprocessor">    #define lan_put_end   lan_put_end0</span>
00363 <span class="preprocessor"></span><span class="preprocessor">    #define lan_def_cbk   lan_def_cbk0</span>
00364 <span class="preprocessor"></span><span class="preprocessor">    #define lan_intr      lan_intr0</span>
00365 <span class="preprocessor"></span><span class="preprocessor">    #define lan_dma_intr  lan_dma_intr0</span>
00366 <span class="preprocessor"></span><span class="preprocessor">    #define lan_dma_ini   lan_dma_ini0</span>
00367 <span class="preprocessor"></span><span class="preprocessor">    #define lan_dma_sts   lan_dma_sts0</span>
00368 <span class="preprocessor"></span><span class="preprocessor">    #define lan_dma_clr   lan_dma_clr0</span>
00369 <span class="preprocessor"></span><span class="preprocessor">    #define lan_dma_sta   lan_dma_sta0</span>
00370 <span class="preprocessor"></span><span class="preprocessor">    #define lan_def_int   lan_def_int0</span>
00371 <span class="preprocessor"></span><span class="preprocessor">    #define lan_undef_int lan_undef_int0</span>
00372 <span class="preprocessor"></span><span class="preprocessor">    #define lan_def_cbk   lan_def_cbk0</span>
00373 <span class="preprocessor"></span><span class="preprocessor">    #define lan_dev_err   lan_dev_err0</span>
00374 <span class="preprocessor"></span><span class="preprocessor">    #define lan_get_eep   lan_get_eep0</span>
00375 <span class="preprocessor"></span><span class="preprocessor">    #define lan_set_eep   lan_set_eep0</span>
00376 <span class="preprocessor"></span><span class="preprocessor">    #define lan_get_mac   lan_get_mac0</span>
00377 <span class="preprocessor"></span><span class="preprocessor">    #define lan_set_mac   lan_set_mac0</span>
00378 <span class="preprocessor"></span><span class="preprocessor">    #define lan_tst_snd   lan_tst_snd0</span>
00379 <span class="preprocessor"></span><span class="preprocessor">    #define lan_tst_rcv   lan_tst_rcv0</span>
00380 <span class="preprocessor"></span><span class="preprocessor">  #elif (DIF_NUM==1)</span>
00381 <span class="preprocessor"></span><span class="preprocessor">    #define lan_ini       lan_ini1</span>
00382 <span class="preprocessor"></span><span class="preprocessor">    #define lan_ini_dev   lan_ini_dev1</span>
00383 <span class="preprocessor"></span><span class="preprocessor">    #define lan_ext_dev   lan_ext_dev1</span>
00384 <span class="preprocessor"></span><span class="preprocessor">    #define lan_wai_rcv   lan_wai_rcv1</span>
00385 <span class="preprocessor"></span><span class="preprocessor">    #define lan_wai_snd   lan_wai_snd1</span>
00386 <span class="preprocessor"></span><span class="preprocessor">    #define lan_get_len   lan_get_len1</span>
00387 <span class="preprocessor"></span><span class="preprocessor">    #define lan_get_pkt   lan_get_pkt1</span>
00388 <span class="preprocessor"></span><span class="preprocessor">    #define lan_skp_pkt   lan_skp_pkt1</span>
00389 <span class="preprocessor"></span><span class="preprocessor">    #define lan_get_end   lan_get_end1</span>
00390 <span class="preprocessor"></span><span class="preprocessor">    #define lan_set_len   lan_set_len1</span>
00391 <span class="preprocessor"></span><span class="preprocessor">    #define lan_put_pkt   lan_put_pkt1</span>
00392 <span class="preprocessor"></span><span class="preprocessor">    #define lan_put_dmy   lan_put_dmy1</span>
00393 <span class="preprocessor"></span><span class="preprocessor">    #define lan_put_end   lan_put_end1</span>
00394 <span class="preprocessor"></span><span class="preprocessor">    #define lan_def_cbk   lan_def_cbk1</span>
00395 <span class="preprocessor"></span><span class="preprocessor">    #define lan_intr      lan_intr1</span>
00396 <span class="preprocessor"></span><span class="preprocessor">    #define lan_dma_intr  lan_dma_intr1</span>
00397 <span class="preprocessor"></span><span class="preprocessor">    #define lan_dma_ini   lan_dma_ini1</span>
00398 <span class="preprocessor"></span><span class="preprocessor">    #define lan_dma_sts   lan_dma_sts1</span>
00399 <span class="preprocessor"></span><span class="preprocessor">    #define lan_dma_clr   lan_dma_clr1</span>
00400 <span class="preprocessor"></span><span class="preprocessor">    #define lan_dma_sta   lan_dma_sta1</span>
00401 <span class="preprocessor"></span><span class="preprocessor">    #define lan_def_int   lan_def_int1</span>
00402 <span class="preprocessor"></span><span class="preprocessor">    #define lan_undef_int lan_undef_int1</span>
00403 <span class="preprocessor"></span><span class="preprocessor">    #define lan_def_cbk   lan_def_cbk1</span>
00404 <span class="preprocessor"></span><span class="preprocessor">    #define lan_dev_err   lan_dev_err1</span>
00405 <span class="preprocessor"></span><span class="preprocessor">    #define lan_get_eep   lan_get_eep1</span>
00406 <span class="preprocessor"></span><span class="preprocessor">    #define lan_set_eep   lan_set_eep1</span>
00407 <span class="preprocessor"></span><span class="preprocessor">    #define lan_get_mac   lan_get_mac1</span>
00408 <span class="preprocessor"></span><span class="preprocessor">    #define lan_set_mac   lan_set_mac1</span>
00409 <span class="preprocessor"></span><span class="preprocessor">    #define lan_tst_snd   lan_tst_snd1</span>
00410 <span class="preprocessor"></span><span class="preprocessor">    #define lan_tst_rcv   lan_tst_rcv1</span>
00411 <span class="preprocessor"></span><span class="preprocessor">  #elif (DIF_NUM==2)</span>
00412 <span class="preprocessor"></span><span class="preprocessor">    #define lan_ini       lan_ini2</span>
00413 <span class="preprocessor"></span><span class="preprocessor">    #define lan_ini_dev   lan_ini_dev2</span>
00414 <span class="preprocessor"></span><span class="preprocessor">    #define lan_ext_dev   lan_ext_dev2</span>
00415 <span class="preprocessor"></span><span class="preprocessor">    #define lan_wai_rcv   lan_wai_rcv2</span>
00416 <span class="preprocessor"></span><span class="preprocessor">    #define lan_wai_snd   lan_wai_snd2</span>
00417 <span class="preprocessor"></span><span class="preprocessor">    #define lan_get_len   lan_get_len2</span>
00418 <span class="preprocessor"></span><span class="preprocessor">    #define lan_get_pkt   lan_get_pkt2</span>
00419 <span class="preprocessor"></span><span class="preprocessor">    #define lan_skp_pkt   lan_skp_pkt2</span>
00420 <span class="preprocessor"></span><span class="preprocessor">    #define lan_get_end   lan_get_end2</span>
00421 <span class="preprocessor"></span><span class="preprocessor">    #define lan_set_len   lan_set_len2</span>
00422 <span class="preprocessor"></span><span class="preprocessor">    #define lan_put_pkt   lan_put_pkt2</span>
00423 <span class="preprocessor"></span><span class="preprocessor">    #define lan_put_dmy   lan_put_dmy2</span>
00424 <span class="preprocessor"></span><span class="preprocessor">    #define lan_put_end   lan_put_end2</span>
00425 <span class="preprocessor"></span><span class="preprocessor">    #define lan_def_cbk   lan_def_cbk2</span>
00426 <span class="preprocessor"></span><span class="preprocessor">    #define lan_intr      lan_intr2</span>
00427 <span class="preprocessor"></span><span class="preprocessor">    #define lan_dma_intr  lan_dma_intr2</span>
00428 <span class="preprocessor"></span><span class="preprocessor">    #define lan_dma_ini   lan_dma_ini2</span>
00429 <span class="preprocessor"></span><span class="preprocessor">    #define lan_dma_sts   lan_dma_sts2</span>
00430 <span class="preprocessor"></span><span class="preprocessor">    #define lan_dma_clr   lan_dma_clr2</span>
00431 <span class="preprocessor"></span><span class="preprocessor">    #define lan_dma_sta   lan_dma_sta2</span>
00432 <span class="preprocessor"></span><span class="preprocessor">    #define lan_dma_int   lan_dma_int2</span>
00433 <span class="preprocessor"></span><span class="preprocessor">    #define lan_def_int   lan_def_int2</span>
00434 <span class="preprocessor"></span><span class="preprocessor">    #define lan_undef_int lan_undef_int2</span>
00435 <span class="preprocessor"></span><span class="preprocessor">    #define lan_def_cbk   lan_def_cbk2</span>
00436 <span class="preprocessor"></span><span class="preprocessor">    #define lan_dev_err   lan_dev_err2</span>
00437 <span class="preprocessor"></span><span class="preprocessor">    #define lan_get_eep   lan_get_eep2</span>
00438 <span class="preprocessor"></span><span class="preprocessor">    #define lan_set_eep   lan_set_eep2</span>
00439 <span class="preprocessor"></span><span class="preprocessor">    #define lan_get_mac   lan_get_mac2</span>
00440 <span class="preprocessor"></span><span class="preprocessor">    #define lan_set_mac   lan_set_mac2</span>
00441 <span class="preprocessor"></span><span class="preprocessor">    #define lan_tst_snd   lan_tst_snd2</span>
00442 <span class="preprocessor"></span><span class="preprocessor">    #define lan_tst_rcv   lan_tst_rcv2</span>
00443 <span class="preprocessor"></span><span class="preprocessor">  #else</span>
00444 <span class="preprocessor"></span><span class="preprocessor">    #error DNIF_NUM is out of range! Customize it.</span>
00445 <span class="preprocessor"></span><span class="preprocessor">  #endif</span>
00446 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00447"></a><a class="code" href="lan9118_8c.html#a23">00447</a> <span class="preprocessor"></span><span class="preprocessor">  #define DIF_NUM   0</span>
00448 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00449 <span class="preprocessor"></span>
00450 <span class="comment">/* 外部参照 */</span>
00451 
00452 <span class="keyword">extern</span> ER <a class="code" href="lan9118_8c.html#a48">lan_def_int</a>(<span class="keywordtype">void</span>);
00453 <span class="keyword">extern</span> ER <a class="code" href="lan9118_8c.html#a49">lan_dma_ini</a>(<span class="keywordtype">void</span>);
00454 <span class="keyword">extern</span> ER <a class="code" href="lan9118_8c.html#a50">lan_undef_int</a>(<span class="keywordtype">void</span>);
00455 
00456 <span class="comment">/* 割込み関連の定義 */</span>
00457 
<a name="l00458"></a><a class="code" href="lan9118_8c.html#a24">00458</a> <span class="preprocessor">#define DEF_RXINT (INT_RSFL)    </span><span class="comment">/* 受信割込みとするメンバーのマスク */</span>
<a name="l00459"></a><a class="code" href="lan9118_8c.html#a25">00459</a> <span class="preprocessor">#define DEF_TXINT (INT_TDFA)    </span><span class="comment">/* 送信割込みとするメンバーのマスク */</span>
00460 
<a name="l00461"></a><a class="code" href="lan9118_8c.html#a26">00461</a> <span class="preprocessor">#define DI_RXINT()  </span><span class="comment">/* Rx割込み禁止 */</span>\
00462 do{\
00463     lan_wreg(INT_EN, 0);\
00464     dly_tick(1);\
00465     lan.mask &amp;= ~DEF_RXINT;\
00466     lan_wreg(INT_EN, lan.mask);\
00467 }while(0)
00468 
<a name="l00469"></a><a class="code" href="lan9118_8c.html#a27">00469</a> <span class="preprocessor">#define EI_RXINT()  </span><span class="comment">/* Rx割込み許可 */</span>\
00470 do{\
00471     lan_wreg(INT_EN, 0);\
00472     dly_tick(1);\
00473     lan.mask |= DEF_RXINT;\
00474     lan_wreg(INT_EN, lan.mask);\
00475 }while(0)
00476 
00477 <span class="preprocessor">#if NO_DMA</span>
00478 <span class="preprocessor"></span><span class="preprocessor">#define DI_ALLINT_START()  do{lan_wreg(INT_EN, 0);dly_tick(1)</span>
00479 <span class="preprocessor"></span><span class="preprocessor">#define DI_ALLINT_END()                                     } while(0)</span>
00480 <span class="preprocessor"></span><span class="preprocessor">#define RX_RESTART()</span>
00481 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00482"></a><a class="code" href="lan9118_8c.html#a28">00482</a> <span class="preprocessor"></span><span class="preprocessor">#define DI_ALLINT_START()  do{UINT psw; psw = vdis_psw()</span>
<a name="l00483"></a><a class="code" href="lan9118_8c.html#a29">00483</a> <span class="preprocessor"></span><span class="preprocessor">#define DI_ALLINT_END()                       vset_psw(psw);} while(0)</span>
<a name="l00484"></a><a class="code" href="lan9118_8c.html#a30">00484</a> <span class="preprocessor"></span><span class="preprocessor">#define RX_RESTART() lan_dma_restart()</span>
00485 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00486 <span class="preprocessor"></span>
<a name="l00487"></a><a class="code" href="lan9118_8c.html#a31">00487</a> <span class="preprocessor">#define DI_TXINT()  </span><span class="comment">/* Tx割込み禁止 */</span>\
00488 do{\
00489     DI_ALLINT_START();\
00490     lan.mask &amp;= ~DEF_TXINT;\
00491     lan_wreg(INT_EN, lan.mask);\
00492     DI_ALLINT_END();\
00493 }while(0)
00494 
<a name="l00495"></a><a class="code" href="lan9118_8c.html#a32">00495</a> <span class="preprocessor">#define EI_TXINT()  </span><span class="comment">/* Tx割込み許可 */</span>\
00496 do{\
00497     DI_ALLINT_START();\
00498     lan.mask |= DEF_TXINT;\
00499     lan_wreg(INT_EN, lan.mask);\
00500     DI_ALLINT_END();\
00501 }while(0)
00502 
<a name="l00503"></a><a class="code" href="lan9118_8c.html#a33">00503</a> <span class="preprocessor">#define EI_PHYINT() </span><span class="comment">/* PHY割込み許可 */</span>\
00504 do{\
00505     DI_ALLINT_START();\
00506     lan.mask |= INT_PHY;\
00507     lan_wreg(INT_EN, lan.mask);\
00508     DI_ALLINT_END();\
00509 }while(0)
00510 
00511 <span class="comment">/*****************************************************************************</span>
00512 <span class="comment">* 状態変化時のコールバック関数の呼び出し</span>
00513 <span class="comment">*</span>
00514 <span class="comment">******************************************************************************/</span>
00515 
00516 <span class="keyword">static</span> <span class="keywordtype">void</span> lan_callback(ER ercd)
00517 {
00518     <a class="code" href="lan9118_8c.html#a42">LAN_CALLBACK</a> func;
00519 
00520     <span class="keywordflow">if</span> ((func = (<a class="code" href="lan9118_8c.html#a42">LAN_CALLBACK</a>)lan.<a class="code" href="structt__lan.html#o0">callback</a>) != NULL)
00521         func(<a class="code" href="lan9118_8c.html#a23">DIF_NUM</a>, ercd, <span class="stringliteral">""</span>);
00522 }
00523 
00524 <span class="comment">/*****************************************************************************</span>
00525 <span class="comment">* 致命的エラー</span>
00526 <span class="comment">*</span>
00527 <span class="comment">******************************************************************************/</span>
00528 
<a name="l00529"></a><a class="code" href="lan9118_8c.html#a52">00529</a> ER <a class="code" href="lan9118_8c.html#a52">lan_dev_err</a>(ER ercd, <span class="keyword">const</span> <span class="keywordtype">char</span> *s)
00530 {
00531     <a class="code" href="lan9118_8c.html#a42">LAN_CALLBACK</a> func;
00532 
00533     <span class="keywordflow">if</span> ((func = (<a class="code" href="lan9118_8c.html#a42">LAN_CALLBACK</a>)lan.<a class="code" href="structt__lan.html#o0">callback</a>) == NULL)
00534         <span class="keywordflow">return</span> ercd;
00535     <span class="keywordflow">return</span> func(<a class="code" href="lan9118_8c.html#a23">DIF_NUM</a>, ercd, s);
00536 }
00537 
00538 <span class="comment">/*****************************************************************************</span>
00539 <span class="comment">* Read after Write timing delay</span>
00540 <span class="comment">*</span>
00541 <span class="comment">******************************************************************************/</span>
00542 
00543 <span class="keyword">static</span> <span class="keywordtype">void</span> dly_tick(<span class="keywordtype">unsigned</span> n)
00544 {
00545     <span class="keywordflow">do</span>{
00546         lan_in32(BYTE_TEST);  <span class="comment">/* dummy read */</span>
00547     } <span class="keywordflow">while</span> (--n);
00548 }
00549 
00550 <span class="comment">/*****************************************************************************</span>
00551 <span class="comment">* Write MAC Control and Status Register</span>
00552 <span class="comment">*</span>
00553 <span class="comment">******************************************************************************/</span>
00554 
00555 <span class="keyword">static</span> <span class="keywordtype">void</span> mac_wreg(UB index, UW data)
00556 {
00557     <span class="keywordflow">while</span> (lan_rreg(MAC_CSR_CMD) &amp; CSR_BUSY);  <span class="comment">/* wait until READY */</span>
00558     lan_wreg(MAC_CSR_DATA, data);
00559     lan_wreg(MAC_CSR_CMD, CSR_BUSY | index);
00560     dly_tick(1);  <span class="comment">/* wait after "MAC_CSR_CMD read" write cycle */</span>
00561 }
00562 
00563 <span class="comment">/*****************************************************************************</span>
00564 <span class="comment">* Read MAC Control and Status Register</span>
00565 <span class="comment">*</span>
00566 <span class="comment">******************************************************************************/</span>
00567 
00568 <span class="keyword">static</span> UW mac_rreg(UB index)
00569 {
00570     <span class="keywordflow">while</span> (lan_rreg(MAC_CSR_CMD) &amp; CSR_BUSY);  <span class="comment">/* wait until READY */</span>
00571     lan_wreg(MAC_CSR_CMD, CSR_BUSY | CSR_RD | index);
00572     dly_tick(1);
00573     <span class="keywordflow">while</span> (lan_rreg(MAC_CSR_CMD) &amp; CSR_BUSY);  <span class="comment">/* wait until READY */</span>
00574 
00575     <span class="keywordflow">return</span> lan_rreg(MAC_CSR_DATA);
00576 }
00577 
00578 <span class="comment">/*****************************************************************************</span>
00579 <span class="comment">* PHYレジスタ書き込み</span>
00580 <span class="comment">*</span>
00581 <span class="comment">******************************************************************************/</span>
00582 
00583 <span class="keyword">static</span> <span class="keywordtype">void</span> PHY_write(<span class="keywordtype">int</span> reg, <span class="keywordtype">int</span> dat)
00584 {
00585     <span class="keywordflow">while</span> (mac_rreg(MAC_MII_ACC) &amp; MII_BUSY);  <span class="comment">/* wait until READY */</span>
00586     mac_wreg(MAC_MII_DATA, dat);
00587     mac_wreg(MAC_MII_ACC, (PHYAD &lt;&lt; MII_PHYAD_SHFT)
00588                          |(reg   &lt;&lt; MII_INDEX_SHFT)
00589                          | MII_WR | MII_BUSY);
00590 }
00591 
00592 <span class="comment">/*****************************************************************************</span>
00593 <span class="comment">* PHYレジスタ読み出し</span>
00594 <span class="comment">*</span>
00595 <span class="comment">******************************************************************************/</span>
00596 
00597 <span class="keyword">static</span> UH PHY_read(<span class="keywordtype">int</span> reg)
00598 {
00599     <span class="keywordflow">while</span> (mac_rreg(MAC_MII_ACC) &amp; MII_BUSY);  <span class="comment">/* wait until READY */</span>
00600     mac_wreg(MAC_MII_ACC, (PHYAD &lt;&lt; MII_PHYAD_SHFT)
00601                          |(reg   &lt;&lt; MII_INDEX_SHFT)
00602                          | MII_BUSY);
00603     <span class="keywordflow">while</span> (mac_rreg(MAC_MII_ACC) &amp; MII_BUSY);  <span class="comment">/* wait until READY */</span>
00604 
00605     <span class="keywordflow">return</span> (UH)mac_rreg(MAC_MII_DATA);
00606 }
00607 
00608 <span class="comment">/*****************************************************************************</span>
00609 <span class="comment">* PHYのソフトリセット</span>
00610 <span class="comment">*</span>
00611 <span class="comment">******************************************************************************/</span>
00612 
00613 static <span class="keywordtype">void</span> PHY_reset(<span class="keywordtype">void</span>)
00614 {
00615     <span class="keywordtype">int</span> i;
00616 
00617     PHY_write(PHY_CR, PHY_CR_RST);      <span class="comment">/* PHY software reset */</span>
00618 
00619     <span class="comment">/* リセット解除まち(実際は即時終了。念のためMax.500msec監視) */</span>
00620     <span class="keywordflow">for</span> (i=0; i&lt;50; i++){
00621         <span class="keywordflow">if</span> (!(PHY_read(PHY_CR) &amp; PHY_CR_RST))
00622             break;
00623         dly_tsk(10/MSEC);
00624     }
00625 }
00626 
00627 <span class="comment">/*****************************************************************************</span>
00628 <span class="comment">* Get LINK status</span>
00629 <span class="comment">*</span>
00630 <span class="comment">******************************************************************************/</span>
00631 
00632 static ER PHY_link(<span class="keywordtype">void</span>)
00633 {
00634     UH mode;
00635 
00636     PHY_read(PHY_SR);            <span class="comment">/* clear */</span>
00637     mode = PHY_read(PHY_SR);
00638     <span class="keywordflow">if</span> (!(mode &amp; PHY_SR_LINK))
00639         return LAN_LNK_OFF;      <span class="comment">/* LINK down */</span>
00640     mode = PHY_mode;
00641 
00642     <span class="comment">/* FIX mode */</span>
00643 
00644     if (PHY_auto != TRUE){
00645         <span class="keywordflow">if</span> (mode == FD100)
00646             return LAN_LNK_100F;
00647         if (mode == HD100)
00648             return LAN_LNK_100H;
00649         if (mode == FD10)
00650             return LAN_LNK_10F;
00651         else
00652             return LAN_LNK_10H;
00653     }
00654 
00655     <span class="comment">/* AutoNegotiation */</span>
00656 
00657     while(!(PHY_read(PHY_SR) &amp; PHY_SR_AN_OK))
00658         dly_tsk(100/MSEC);
00659 
00660     mode &amp;= PHY_read(PHY_ANLPA);
00661     if (mode &amp; AFD100)
00662         return LAN_LNK_100F;
00663     else
00664     if (mode &amp; AHD100)
00665         return LAN_LNK_100H;
00666     else
00667     if (mode &amp; AFD10)
00668         return LAN_LNK_10F;
00669     else
00670         return LAN_LNK_10H;
00671 }
00672 
00673 <span class="comment">/*****************************************************************************</span>
00674 <span class="comment">* PHY acknowledge interrupt</span>
00675 <span class="comment">*</span>
00676 <span class="comment">******************************************************************************/</span>
00677 
00678 static <span class="keywordtype">void</span> PHY_int_ack(<span class="keywordtype">void</span>)
00679 {
00680     PHY_read(PHY_ISR);  <span class="comment">/* clear */</span>
00681 }
00682 
00683 <span class="comment">/*****************************************************************************</span>
00684 <span class="comment">* PHY initialize interrupt</span>
00685 <span class="comment">*</span>
00686 <span class="comment">******************************************************************************/</span>
00687 
00688 <span class="keyword">static</span> <span class="keywordtype">void</span> PHY_init_int(<span class="keywordtype">void</span>)
00689 {
00690     PHY_read(PHY_ISR);                <span class="comment">/* clear */</span>
00691     PHY_write(PHY_IMR, PHY_INT_LINK); <span class="comment">/* enable interrupt */</span>
00692 }
00693 
00694 <span class="comment">/*****************************************************************************</span>
00695 <span class="comment">* PHY初期化</span>
00696 <span class="comment">*</span>
00697 <span class="comment">* nego  TRUE = Auto-Negotiation Enable, FALSE = Auto-Negotiation Disable</span>
00698 <span class="comment">* mode  HD10   =10BASE-T  /半2重</span>
00699 <span class="comment">*       FD10   =10BASE-T  /全2重</span>
00700 <span class="comment">*       HD100  =100BASE-TX/半2重</span>
00701 <span class="comment">*       FD100  =100BASE-TX/全2重</span>
00702 <span class="comment">*       AHD10  =10BASE-T  /半2重(Auto-Negotiation)</span>
00703 <span class="comment">*       AFD10  =10BASE-T  /全2重(Auto-Negotiation)</span>
00704 <span class="comment">*       AHD100 =100BASE-TX/半2重(Auto-Negotiation)</span>
00705 <span class="comment">*       AFD100 =100BASE-TX/全2重(Auto-Negotiation)</span>
00706 <span class="comment">*</span>
00707 <span class="comment">* 注1) AXXXXは(AHD10|AHD100)と書いて10M半2重と100M半2重の接続を許すという</span>
00708 <span class="comment">*      意味になる。</span>
00709 <span class="comment">* 注2) AXXXXでない方は複数のORは書けません。</span>
00710 <span class="comment">******************************************************************************/</span>
00711 
00712 <span class="keyword">static</span> ER PHY_init(BOOL nego, <span class="keywordtype">int</span> mode, <span class="keywordtype">int</span> lbtype)
00713 {
00714     <span class="keywordtype">int</span> i;
00715     ER rtcd;
00716 
00717     PHY_auto = nego;
00718     PHY_mode = mode;
00719 
00720     <span class="keywordflow">if</span> (nego) {                     <span class="comment">/* Auto Negotiationモードにする */</span>
00721         PHY_write(PHY_ANA, mode | PHY_AN_802_3);
00722         mode = PHY_CR_ANEG_EN|PHY_CR_ANEG_RST;
00723         PHY_write(PHY_CR, (UH)mode);  <span class="comment">/* Re-Start Auto-Negotiation */</span>
00724     }
00725     <span class="keywordflow">else</span> {                          <span class="comment">/* Manual mode settings */</span>
00726         <span class="keywordflow">if</span> (lbtype != 0)
00727             mode |= PHY_CR_LPBK|PHY_CR_DPLX; <span class="comment">/* 強制ループバックの設定 */</span>
00728         PHY_write(PHY_CR, (UH)mode);    <span class="comment">/* Set Speed and Duplex mode */</span>
00729     }
00730 
00731     <span class="comment">/* LINK状態監視(起動直後のUPまでMax.3sec監視) */</span>
00732     <span class="comment">/* 10Base-TのLOOPBACKモードではLINK UPにならないため除く */</span>
00733     if (mode != (FD10|PHY_CR_LPBK)){
00734         <span class="keywordflow">for</span> (i=0; i&lt;30; i++){
00735             <span class="keywordflow">if</span> (PHY_read(PHY_SR) &amp; PHY_SR_LINK)
00736                 break;
00737             dly_tsk(100/MSEC);
00738         }
00739         rtcd = PHY_link();
00740     } else {
00741         rtcd = LAN_LNK_10F;  <span class="comment">/* 無条件に */</span>
00742     }
00743 
00744     PHY_init_int();
00745     <span class="keywordflow">return</span> rtcd;
00746 }
00747 
00748 <span class="preprocessor">#ifndef lan_outdrep</span>
00749 <span class="preprocessor"></span><span class="comment">/*****************************************************************************</span>
00750 <span class="comment">* LANコントローラへパケットデータ書き込み</span>
00751 <span class="comment">*</span>
00752 <span class="comment">******************************************************************************/</span>
00753 
00754 <span class="keyword">static</span> <span class="keywordtype">void</span> lan_outdrep(UW *b, <span class="keywordtype">int</span> len)
00755 {
00756     <span class="keywordtype">int</span> i;
00757 <span class="preprocessor">  #if (defined(BIG_ENDIAN) &amp;&amp; !BUS_SWAP)</span>
00758 <span class="preprocessor"></span>    UB *p, *q, pq;
00759 <span class="preprocessor">  #endif</span>
00760 <span class="preprocessor"></span>
00761     <span class="comment">/* データ並び不一致なら、並び替え */</span>
00762 <span class="preprocessor">  #if (defined(BIG_ENDIAN) &amp;&amp; !BUS_SWAP)</span>
00763 <span class="preprocessor"></span>    p = (UB *)b;
00764     q = p - 2;
00765     <span class="keywordflow">for</span> (i = len; i &gt; 0; i -= 4) {
00766         q += 5;
00767         pq = *q;
00768         *q-- = *p;
00769         *p++ = pq;
00770         pq = *q;
00771         *q = *p;
00772         *p = pq;
00773         p += 3;
00774     }
00775 <span class="preprocessor">  #endif</span>
00776 <span class="preprocessor"></span>
00777     <span class="comment">/* LANコントローラへ書き込み */</span>
00778     <span class="keywordflow">for</span> (i = len; i &gt;= 60; i -= 60) {
00779         lan_outd(TX_DATA, *b++);
00780         lan_outd(TX_DATA, *b++);
00781         lan_outd(TX_DATA, *b++);
00782         lan_outd(TX_DATA, *b++);
00783         lan_outd(TX_DATA, *b++);
00784         lan_outd(TX_DATA, *b++);
00785         lan_outd(TX_DATA, *b++);
00786         lan_outd(TX_DATA, *b++);
00787         lan_outd(TX_DATA, *b++);
00788         lan_outd(TX_DATA, *b++);
00789         lan_outd(TX_DATA, *b++);
00790         lan_outd(TX_DATA, *b++);
00791         lan_outd(TX_DATA, *b++);
00792         lan_outd(TX_DATA, *b++);
00793         lan_outd(TX_DATA, *b++);
00794     }
00795     <span class="keywordflow">for</span> (; i &gt; 0; i -= 4)
00796         lan_outd(TX_DATA, *b++);
00797 }
00798 
00799 #endif
00800 #ifndef lan_indrep
00801 <span class="comment">/*****************************************************************************</span>
00802 <span class="comment">* LANコントローラからパケットデータ読み出し</span>
00803 <span class="comment">*</span>
00804 <span class="comment">******************************************************************************/</span>
00805 
00806 static <span class="keywordtype">void</span> lan_indrep(UW *b, <span class="keywordtype">int</span> len)
00807 {
00808     <span class="keywordtype">int</span> i;
00809 <span class="preprocessor">  #if (defined(BIG_ENDIAN) &amp;&amp; !BUS_SWAP)</span>
00810 <span class="preprocessor"></span>    UB *p, *q, pq;
00811 <span class="preprocessor">  #endif</span>
00812 <span class="preprocessor"></span>
00813 <span class="preprocessor">  #if (defined(BIG_ENDIAN) &amp;&amp; !BUS_SWAP)</span>
00814 <span class="preprocessor"></span>    p = (UB *)b;
00815 <span class="preprocessor">  #endif</span>
00816 <span class="preprocessor"></span>
00817     <span class="keywordflow">for</span> (i = len; i &gt;= 60; i -= 60) {
00818         *b++ = lan_ind(RX_DATA);
00819         *b++ = lan_ind(RX_DATA);
00820         *b++ = lan_ind(RX_DATA);
00821         *b++ = lan_ind(RX_DATA);
00822         *b++ = lan_ind(RX_DATA);
00823         *b++ = lan_ind(RX_DATA);
00824         *b++ = lan_ind(RX_DATA);
00825         *b++ = lan_ind(RX_DATA);
00826         *b++ = lan_ind(RX_DATA);
00827         *b++ = lan_ind(RX_DATA);
00828         *b++ = lan_ind(RX_DATA);
00829         *b++ = lan_ind(RX_DATA);
00830         *b++ = lan_ind(RX_DATA);
00831         *b++ = lan_ind(RX_DATA);
00832         *b++ = lan_ind(RX_DATA);
00833     }
00834     <span class="keywordflow">for</span> (; i &gt; 0; i -= 4)
00835         *b++ = lan_ind(RX_DATA);
00836 
00837     <span class="comment">/* データ並び不一致なら、並び替え */</span>
00838 <span class="preprocessor">  #if (defined(BIG_ENDIAN) &amp;&amp; !BUS_SWAP)</span>
00839 <span class="preprocessor"></span>    q = p - 2;
00840     <span class="keywordflow">for</span> (i = len; i &gt; 0; i -= 4) {
00841         q += 5;
00842         pq = *q;
00843         *q-- = *p;
00844         *p++ = pq;
00845         pq = *q;
00846         *q = *p;
00847         *p = pq;
00848         p += 3;
00849     }
00850 <span class="preprocessor">  #endif</span>
00851 <span class="preprocessor"></span>}
00852 
00853 <span class="preprocessor">#endif</span>
00854 <span class="preprocessor"></span><span class="comment">/*****************************************************************************</span>
00855 <span class="comment">* MACアドレスのチェック</span>
00856 <span class="comment">*</span>
00857 <span class="comment">******************************************************************************/</span>
00858 
00859 <span class="keyword">static</span> <span class="keywordtype">int</span> check_macaddr(UB *macaddr)
00860 {
00861     <span class="keywordtype">int</span> i, sum;
00862 
00863     <span class="keywordflow">for</span> (sum = i = 0; i &lt; 6; i++)
00864         sum += macaddr[i];
00865     if (sum == 0)
00866         return 0;               <span class="comment">/* All 0 */</span>
00867     else if (sum == 0xff * 6)
00868         return -1;              <span class="comment">/* All F */</span>
00869     else
00870         return 1;               <span class="comment">/* other */</span>
00871 
00872 }
00873 
00874 <span class="comment">/*****************************************************************************</span>
00875 <span class="comment">* バッファディスクリプタの初期化</span>
00876 <span class="comment">*</span>
00877 <span class="comment">******************************************************************************/</span>
00878 static BOOL bd_ini(<span class="keywordtype">void</span>)
00879 {
00880     <span class="keywordtype">int</span> i;
00881     <a class="code" href="structt__bd.html">T_BD</a> *rbd;
00882     <a class="code" href="structt__bd.html">T_BD</a> *tbd;
00883     UB *p;
00884 
00885     pTxBD  = TxBD;
00886     pRxBD  = cRxBD = RxBD;
00887 
00888 <span class="preprocessor">  #ifndef LAN_BUF_ALLOC</span>
00889 <span class="preprocessor"></span>    p = (UB *)(ALIGN(TxBuf, BUFF_ALIGN));
00890     p += <a class="code" href="lan9118_8c.html#a6">LAN_BUF_BASE</a>;
00891 <span class="preprocessor">  #else</span>
00892 <span class="preprocessor"></span>    p = (UB *)(ALIGN(lan_alloc(NUM_TXBDS * SEND_BUFF_SIZE +BUFF_ALIGN-1), BUFF_ALIGN));
00893     <span class="keywordflow">if</span> (!p)
00894         return FALSE;
00895   #endif
00896     tbd = pTxBD;
00897     for (i = 0; i &lt; NUM_TXBDS; i++, tbd++){
00898         tbd-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o9">tx</a>.<a class="code" href="structt__bd.html#o1">cmd_a</a> = 0;
00899         tbd-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o9">tx</a>.<a class="code" href="structt__bd.html#o2">cmd_b</a> = 0;
00900         tbd-&gt;<a class="code" href="structt__bd.html#o0">buf</a> = p;
00901         p += <a class="code" href="lan9118_8c.html#a17">SEND_BUFF_SIZE</a>;
00902         tbd-&gt;<a class="code" href="structt__bd.html#o6">next</a> = tbd + 1;  <span class="comment">/* LINK to next BD */</span>
00903     }
00904     tbd--;
00905     tbd-&gt;<a class="code" href="structt__bd.html#o6">next</a> = pTxBD;    <span class="comment">/* LINK to 1st BD */</span>
00906 
00907 <span class="preprocessor">  #ifndef LAN_BUF_ALLOC</span>
00908 <span class="preprocessor"></span>    p = (UB *)(ALIGN(RxBuf, BUFF_ALIGN));
00909     p += <a class="code" href="lan9118_8c.html#a6">LAN_BUF_BASE</a>;
00910 <span class="preprocessor">  #else</span>
00911 <span class="preprocessor"></span>    p = (UB *)(ALIGN(lan_alloc(NUM_RXBDS * RECV_BUFF_SIZE +BUFF_ALIGN-1), BUFF_ALIGN));
00912     <span class="keywordflow">if</span> (!p)
00913         return FALSE;
00914   #endif
00915     rbd = pRxBD;
00916     for (i = 0; i &lt; NUM_RXBDS; i++, rbd++){
00917         rbd-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o7">rx</a>.<a class="code" href="structt__bd.html#o4">ctl</a> = <a class="code" href="lan9118_8c.html#a13">RX_BD_RDY</a>;
00918         rbd-&gt;<a class="code" href="structt__bd.html#o0">buf</a> = p;
00919         p += <a class="code" href="lan9118_8c.html#a16">RECV_BUFF_SIZE</a>;
00920         rbd-&gt;<a class="code" href="structt__bd.html#o6">next</a> = rbd + 1;  <span class="comment">/* LINK to next BD */</span>
00921     }
00922     rbd--;
00923     rbd-&gt;<a class="code" href="structt__bd.html#o6">next</a> = pRxBD;    <span class="comment">/* LINK to 1st BD */</span>
00924 
00925     <span class="keywordflow">return</span> TRUE;
00926 }
00927 
00928 <span class="comment">/*****************************************************************************</span>
00929 <span class="comment">* LANコントローラ初期化(ループバックのタイプ指定付き)</span>
00930 <span class="comment">*</span>
00931 <span class="comment">* macaddr   MACアドレス(6バイトの配列)へのポインタ</span>
00932 <span class="comment">*</span>
00933 <span class="comment">* lbtype    ループバックのタイプ(0〜2)</span>
00934 <span class="comment">*           0 = ループバック禁止(標準)</span>
00935 <span class="comment">*           1 = 内部ループバック(MAC)</span>
00936 <span class="comment">*           2 = 外部ループバック(PHY)</span>
00937 <span class="comment">******************************************************************************/</span>
00938 
<a name="l00939"></a><a class="code" href="lan9118_8c.html#a66">00939</a> ER <a class="code" href="lan9118_8c.html#a66">lan_ini_dev</a>(UB *macaddr, <span class="keywordtype">int</span> lbtype)
00940 {
00941     ER <a class="code" href="lan9118_8c.html#a85">lan_tst_snd</a>(<span class="keywordtype">void</span>);
00942     ER <a class="code" href="lan9118_8c.html#a86">lan_tst_rcv</a>(<span class="keywordtype">void</span>);
00943 
00944     <span class="keywordtype">int</span> i,j;
00945     BOOL eep;
00946     ER ercd;
00947     UW tmp;
00948     UW mac_addrl, mac_addrh;
00949     ER mode;
00950 
00951     <span class="comment">/* 内部変数を初期化 */</span>
00952     memset(&amp;lan, 0, <span class="keyword">sizeof</span> (<a class="code" href="structt__lan.html">T_LAN</a>));
00953 
00954     <span class="keywordflow">if</span> (callbackini)
00955         lan.<a class="code" href="structt__lan.html#o0">callback</a> = callbackini;
00956 
00957     dly_tsk(30/MSEC);   <span class="comment">/* &gt;=25ms delay after power-on reset (On the safer side) */</span>
00958 
00959 <span class="preprocessor">  #if defined(BIG_ENDIAN) &amp;&amp; BUSSZ == 16 &amp;&amp; BUS_SWAP == 0</span>
00960 <span class="preprocessor"></span>    lan_wreg(ENDIAN_CTL, lan_rreg(ENDIAN_CTL)|0xffffffff);
00961 <span class="preprocessor">  #endif</span>
00962 <span class="preprocessor"></span>
00963     <span class="comment">/* Testing register R/W */</span>
00964 
00965     <span class="keywordflow">if</span> ((tmp = lan_rreg(BYTE_TEST)) != BYTE_TEST_VAL)
00966         <span class="keywordflow">return</span> <a class="code" href="lan9118_8c.html#a52">lan_dev_err</a>(-1, <span class="stringliteral">"BYTE_TEST error"</span>);
00967     tmp ^= lan_rreg(BYTE_TEST);
00968     <span class="keywordflow">if</span> (tmp != 0)
00969         <span class="keywordflow">return</span> <a class="code" href="lan9118_8c.html#a52">lan_dev_err</a>(-1, <span class="stringliteral">"read error"</span>);
00970 
00971     <span class="keywordflow">while</span>(lan_rreg(MAC_CSR_CMD) &amp; CSR_BUSY);
00972     lan_wreg(MAC_CSR_CMD, 0);                     <span class="comment">/* R/nW bit low */</span>
00973 
00974     <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++){
00975         lan_wreg(MAC_CSR_DATA, BYTE_TEST_VAL);
00976         tmp  = lan_rreg(BYTE_TEST);  <span class="comment">/* for wait read after write */</span>
00977         tmp ^= lan_rreg(MAC_CSR_DATA);
00978 
00979         <span class="keywordflow">if</span> (tmp != 0)
00980             <span class="keywordflow">return</span> <a class="code" href="lan9118_8c.html#a52">lan_dev_err</a>(-1, <span class="stringliteral">"write error"</span>);
00981     }
00982 
00983     <span class="comment">/* Reset */</span>
00984 
00985     lan_wreg(HW_CFG, HWCFG_SRST);
00986     dly_tick(1);
00987     <span class="keywordflow">while</span> (lan_rreg(HW_CFG) &amp; HWCFG_SRST);
00988 
00989     PHY_reset();
00990 
00991     <span class="comment">/* Setting */</span>
00992 
00993     lan_wreg(HW_CFG, HWCFG_SF|HWCFG_TFSZ3);  <span class="comment">/* TX Data FIFO size = 2560 */</span>
00994     lan_wreg(GPIO_CFG, GPIO_LED3|GPIO_LED2|GPIO_LED1);  <span class="comment">/* Set the LED output */</span>
00995     lan_wreg(FIFO_INT, 0x18000000);  <span class="comment">/* TFDA &gt; 1536, RSFL &gt; 0, other don't care */</span>
00996 
00997     <span class="comment">/* MACアドレスを何処から取得するか？ */</span>
00998     <span class="keywordflow">if</span> (check_macaddr(macaddr) &lt;= 0)
00999         eep = TRUE;                    <span class="comment">/* 000000かFFFFFFならEEPROMの値 */</span>
01000     <span class="keywordflow">else</span>
01001         eep = FALSE;                   <span class="comment">/* それ以外ならmacaddr引数を使う */</span>
01002 
01003     <span class="comment">/* EEPROMの値をMACアドレスとする */</span>
01004     <span class="keywordflow">if</span> (eep) {
01005         <span class="keywordflow">if</span> (!(lan_rreg(E2P_CMD) &amp; E2P_MACLO)){  <span class="comment">/* Auto-load after reset fail */</span>
01006             mac_addrl = 0xffffffff;
01007             mac_addrh = 0xffffffff;
01008         }<span class="keywordflow">else</span>{
01009             mac_addrl = mac_rreg(MAC_ADDRL);
01010             mac_addrh = mac_rreg(MAC_ADDRH);
01011         }
01012         macaddr[0] = (UB)(mac_addrl);
01013         macaddr[1] = (UB)(mac_addrl &gt;&gt; 8);
01014         macaddr[2] = (UB)(mac_addrl &gt;&gt; 16);
01015         macaddr[3] = (UB)(mac_addrl &gt;&gt; 24);
01016         macaddr[4] = (UB)(mac_addrh);
01017         macaddr[5] = (UB)(mac_addrh &gt;&gt; 8);
01018 
01019         <span class="comment">/* 不正なMACアドレスならローカルなMACアドレスを仮割り当て */</span>
01020         <span class="keywordflow">if</span> (check_macaddr(macaddr) &lt;= 0) {
01021             macaddr[0] = 0x12; macaddr[1] = 0x34;
01022             macaddr[2] = 0x56; macaddr[3] = 0x78;
01023             macaddr[4] = 0x9A; macaddr[5] = 0xBC;
01024             eep = FALSE;
01025         }
01026     }
01027 
01028     <span class="comment">/* MACアドレスをコントローラにセット */</span>
01029     <span class="keywordflow">if</span> (!eep) {
01030         mac_wreg(MAC_ADDRL, (UW)macaddr[0] | ((UW)macaddr[1] &lt;&lt; 8)
01031                      |((UW)macaddr[2]&lt;&lt;16) | ((UW)macaddr[3] &lt;&lt; 24));
01032         mac_wreg(MAC_ADDRH, (UW)macaddr[4] | ((UW)macaddr[5] &lt;&lt; 8));
01033     }
01034 
01035     <span class="keywordflow">if</span> (bd_ini() == FALSE)        <span class="comment">/* バッファディスクプリタの初期化 */</span>
01036         <span class="keywordflow">return</span> E_PAR;
01037 
01038     <span class="comment">/* TX &amp; RX enable */</span>
01039 
01040     lan_wreg(RX_CFG, <a class="code" href="lan9118_8c.html#a19">RCFG_EA</a>);    <span class="comment">/* End Align = 4 or 16 or 32 */</span>
01041     lan_wreg(TX_CFG, TCFG_SDUMP|TCFG_DDUMP|TCFG_TXSAO|TCFG_TXON);
01042 
01043 <span class="preprocessor">#if BUG_10BASE_POL</span>
01044 <span class="preprocessor"></span>    lan.<a class="code" href="structt__lan.html#o2">mac_cr</a> = MAC_CR_FDPX|MAC_CR_PRMS;  <span class="comment">/* for PHY LOOPBACK TEST */</span>
01045     mac_wreg(MAC_CR, lan.<a class="code" href="structt__lan.html#o2">mac_cr</a> |= MAC_CR_TXEN|MAC_CR_RXEN);
01046 
01047     <span class="comment">/* workaround for 10Base-T device bug */</span>
01048 
01049     PHY_init(FALSE,FD10, 2);    <span class="comment">/* Fixed 10M/Full */</span>
01050     <span class="keywordflow">for</span> (i = 0; i &lt; 501; i++){  <span class="comment">/* 任意回数 */</span>
01051         <span class="keywordflow">for</span> (j = 0; j &lt; 20; j++){
01052             ercd = <a class="code" href="lan9118_8c.html#a85">lan_tst_snd</a>();
01053             <span class="keywordflow">if</span> (ercd != E_OK)
01054                 <span class="keywordflow">break</span>;
01055             ercd = <a class="code" href="lan9118_8c.html#a86">lan_tst_rcv</a>();
01056             <span class="keywordflow">if</span> (ercd != E_OK)
01057                 <span class="keywordflow">break</span>;
01058         }
01059         <span class="keywordflow">if</span> (j == 20)  <span class="comment">/* !!OK!! */</span>
01060             <span class="keywordflow">break</span>;
01061         <span class="keywordflow">else</span>{         <span class="comment">/* !!NG!! */</span>
01062             PHY_reset();
01063             PHY_init(FALSE,FD10, 2);
01064             ercd = -1;
01065         }
01066     }
01067     <span class="keywordflow">if</span> (ercd != E_OK)
01068         <span class="keywordflow">return</span> ercd;
01069 <span class="preprocessor">#endif</span>
01070 <span class="preprocessor"></span>
01071     <span class="comment">/* PHY設定 */</span>
01072 
01073 <span class="preprocessor">#if FULLDPLX == 0</span>
01074 <span class="preprocessor"></span>    mode = PHY_init(TRUE, AFD10|AFD100|AHD10|AHD100, lbtype);  <span class="comment">/* AutoNego */</span>
01075     lan.<a class="code" href="structt__lan.html#o9">sts_new</a> = mode;
01076     lan.<a class="code" href="structt__lan.html#o8">sts_mod</a> = mode = (mode == LAN_LNK_OFF) ? LAN_LNK_100F : mode;
01077 <span class="preprocessor">#elif FULLDPLX == 2</span>
01078 <span class="preprocessor"></span>    mode = PHY_init(FALSE,FD10,lbtype);   <span class="comment">/* Fixed 10M/Full */</span>
01079     lan.<a class="code" href="structt__lan.html#o9">sts_new</a> = mode;
01080     lan.<a class="code" href="structt__lan.html#o8">sts_mod</a> = mode = LAN_LNK_10F;
01081 <span class="preprocessor">#elif FULLDPLX == 4</span>
01082 <span class="preprocessor"></span>    mode = PHY_init(FALSE,FD100,lbtype);  <span class="comment">/* Fixed 100M/Full */</span>
01083     lan.<a class="code" href="structt__lan.html#o9">sts_new</a> = mode;
01084     lan.<a class="code" href="structt__lan.html#o8">sts_mod</a> = mode = LAN_LNK_100F;
01085 <span class="preprocessor">#elif FULLDPLX == 1</span>
01086 <span class="preprocessor"></span>    mode = PHY_init(FALSE,HD10,lbtype);   <span class="comment">/* Fixed 10M/Half */</span>
01087     lan.<a class="code" href="structt__lan.html#o9">sts_new</a> = mode;
01088     lan.<a class="code" href="structt__lan.html#o8">sts_mod</a> = mode = LAN_LNK_10H;
01089 <span class="preprocessor">#elif FULLDPLX == 3</span>
01090 <span class="preprocessor"></span>    mode = PHY_init(FALSE,HD100,lbtype);  <span class="comment">/* Fixed 100M/Half */</span>
01091     lan.<a class="code" href="structt__lan.html#o9">sts_new</a> = mode;
01092     lan.<a class="code" href="structt__lan.html#o8">sts_mod</a> = mode = LAN_LNK_100H;
01093 <span class="preprocessor">#endif</span>
01094 <span class="preprocessor"></span>
01095     lan.<a class="code" href="structt__lan.html#o1">lnk_chg</a> = 0;
01096     lan.<a class="code" href="structt__lan.html#o10">sts_old</a> = LAN_LNK_OFF;
01097 
01098     lan_callback(lan.<a class="code" href="structt__lan.html#o9">sts_new</a>);            <span class="comment">/* リンク状態通知コールバック */</span>
01099 
01100     <span class="comment">/* MAC_CR 再設定 */</span>
01101 
01102     lan.<a class="code" href="structt__lan.html#o2">mac_cr</a> = 0;
01103     <span class="keywordflow">if</span> (mode == LAN_LNK_100F || mode == LAN_LNK_10F)
01104         lan.<a class="code" href="structt__lan.html#o2">mac_cr</a> |= MAC_CR_FDPX;
01105     <span class="keywordflow">else</span>
01106         lan.<a class="code" href="structt__lan.html#o2">mac_cr</a> |= MAC_CR_RCVOWN;
01107 <span class="preprocessor">  #if ALMUL</span>
01108 <span class="preprocessor"></span>    lan.<a class="code" href="structt__lan.html#o2">mac_cr</a> |= MAC_CR_MCPAS;
01109 <span class="preprocessor">  #endif</span>
01110 <span class="preprocessor"></span><span class="preprocessor">  #if PRMS</span>
01111 <span class="preprocessor"></span>    lan.<a class="code" href="structt__lan.html#o2">mac_cr</a> |= MAC_CR_PRMS;
01112 <span class="preprocessor">  #endif</span>
01113 <span class="preprocessor"></span><span class="preprocessor">  #if LBTYPE == 1</span>
01114 <span class="preprocessor"></span>    lan.<a class="code" href="structt__lan.html#o2">mac_cr</a> |= MAC_CR_LOOPBK;
01115 <span class="preprocessor">  #endif</span>
01116 <span class="preprocessor"></span>    mac_wreg(MAC_CR, lan.<a class="code" href="structt__lan.html#o2">mac_cr</a> |= MAC_CR_TXEN|MAC_CR_RXEN);
01117 
01118     <span class="comment">/* 割込みマスクの初期設定 */</span>
01119 
01120     lan_wreg(INT_STS, 0xffffffff);        <span class="comment">/* clear all event */</span>
01121     lan_wreg(IRQ_CFG, IRQ_EN|<a class="code" href="lan9118_8c.html#a11">IRQ_BUFF</a>);   <span class="comment">/* IRQ-pin enable, IRQ buffer type */</span>
01122 
01123     <span class="comment">/* LANコントローラの割込みの登録 */</span>
01124     ercd = <a class="code" href="lan9118_8c.html#a48">lan_def_int</a>();
01125     <span class="keywordflow">if</span> (ercd != E_OK)
01126         <span class="keywordflow">return</span> ercd;
01127 
01128     <span class="comment">/* DMA初期化 */</span>
01129 
01130 <span class="preprocessor">  #if NO_DMA</span>
01131 <span class="preprocessor"></span><span class="preprocessor">  #else</span>
01132 <span class="preprocessor"></span>    ercd = <a class="code" href="lan9118_8c.html#a49">lan_dma_ini</a>();
01133     <span class="keywordflow">if</span> (ercd != E_OK)
01134         <span class="keywordflow">return</span> ercd;
01135 <span class="preprocessor">  #endif</span>
01136 <span class="preprocessor"></span>
01137 <span class="preprocessor">#ifndef RX_MONITOR</span>
01138 <span class="preprocessor"></span><span class="preprocessor">  #if NO_DMA</span>
01139 <span class="preprocessor"></span>    lan_wreg(INT_EN, lan.<a class="code" href="structt__lan.html#o3">mask</a> = INT_PHY);
01140 <span class="preprocessor">  #else</span>
01141 <span class="preprocessor"></span>    lan_wreg(INT_EN, lan.<a class="code" href="structt__lan.html#o3">mask</a> = INT_PHY|<a class="code" href="lan9118_8c.html#a24">DEF_RXINT</a>);
01142 <span class="preprocessor">  #endif</span>
01143 <span class="preprocessor"></span><span class="preprocessor">#else</span>
01144 <span class="preprocessor"></span><span class="preprocessor">  #if NO_DMA</span>
01145 <span class="preprocessor"></span>    lan_wreg(INT_EN, lan.<a class="code" href="structt__lan.html#o3">mask</a> = INT_PHY|INT_RXDF);
01146 <span class="preprocessor">  #else</span>
01147 <span class="preprocessor"></span>    lan_wreg(INT_EN, lan.<a class="code" href="structt__lan.html#o3">mask</a> = INT_PHY|INT_RXDF|<a class="code" href="lan9118_8c.html#a24">DEF_RXINT</a>);
01148 <span class="preprocessor">  #endif</span>
01149 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01150 <span class="preprocessor"></span>    <span class="keywordflow">return</span> ercd;
01151 }
01152 
01153 <span class="comment">/*****************************************************************************</span>
01154 <span class="comment">* LANドライバの終了</span>
01155 <span class="comment">*</span>
01156 <span class="comment">******************************************************************************/</span>
01157 
<a name="l01158"></a><a class="code" href="lan9118_8c.html#a67">01158</a> ER <a class="code" href="lan9118_8c.html#a67">lan_ext_dev</a>(<span class="keywordtype">void</span>)
01159 {
01160     lan_wreg(INT_EN, lan.<a class="code" href="structt__lan.html#o3">mask</a> = 0);
01161     lan_wreg(TX_CFG, lan_rreg(TX_CFG)|TCFG_STOP);  <span class="comment">/* Stop TX */</span>
01162     dly_tick(1);
01163     <span class="keywordflow">while</span> (lan_rreg(TX_CFG) &amp; TCFG_STOP) <span class="comment">/* wait until Tx stop */</span>
01164         dly_tsk(1);
01165 
01166     mac_wreg(MAC_CR, 0);  <span class="comment">/* stop the controller */</span>
01167 
01168     lan.<a class="code" href="structt__lan.html#o7">rxtid</a> = 0;
01169     lan.<a class="code" href="structt__lan.html#o14">txtid</a> = 0;
01170 
01171     <span class="keywordflow">return</span> <a class="code" href="lan9118_8c.html#a50">lan_undef_int</a>();
01172 }
01173 
01174 <span class="comment">/*****************************************************************************</span>
01175 <span class="comment">* LAN コントローラ再初期化</span>
01176 <span class="comment">*</span>
01177 <span class="comment">******************************************************************************/</span>
01178 
01179 <span class="keyword">static</span> <span class="keywordtype">void</span> lan_restart(ER mode)
01180 {
01181     <span class="keywordflow">if</span> (mode == LAN_LNK_100F || mode == LAN_LNK_10F) {
01182         lan.<a class="code" href="structt__lan.html#o2">mac_cr</a> |= MAC_CR_FDPX;
01183         lan.<a class="code" href="structt__lan.html#o2">mac_cr</a> &amp;= ~MAC_CR_RCVOWN;
01184     } <span class="keywordflow">else</span> {
01185         lan.<a class="code" href="structt__lan.html#o2">mac_cr</a> &amp;= ~MAC_CR_FDPX;
01186         lan.<a class="code" href="structt__lan.html#o2">mac_cr</a> |= MAC_CR_RCVOWN;
01187     }
01188 
01189     mac_wreg(MAC_CR, lan.<a class="code" href="structt__lan.html#o2">mac_cr</a>);
01190 }
01191 
01192 <span class="comment">/*****************************************************************************</span>
01193 <span class="comment">* LAN コントローラ初期化</span>
01194 <span class="comment">*</span>
01195 <span class="comment">* macaddr   MACアドレス(6バイトの配列)へのポインタ</span>
01196 <span class="comment">******************************************************************************/</span>
01197 
<a name="l01198"></a><a class="code" href="lan9118_8c.html#a69">01198</a> ER <a class="code" href="lan9118_8c.html#a69">lan_ini</a>(UB *macaddr)
01199 {
01200     <span class="keywordflow">return</span> <a class="code" href="lan9118_8c.html#a66">lan_ini_dev</a>(macaddr, <a class="code" href="lan9118_8c.html#a3">LBTYPE</a>);
01201 }
01202 
01203 <span class="comment">/*****************************************************************************</span>
01204 <span class="comment">* LINK状態変化時の処理</span>
01205 <span class="comment">*</span>
01206 <span class="comment">******************************************************************************/</span>
01207 
01208 <span class="keyword">static</span> <span class="keywordtype">void</span> lan_link(<span class="keywordtype">void</span>)
01209 {
01210     lan.<a class="code" href="structt__lan.html#o10">sts_old</a> = lan.<a class="code" href="structt__lan.html#o9">sts_new</a>;
01211     <span class="keywordflow">if</span> (lan.<a class="code" href="structt__lan.html#o1">lnk_chg</a>) {
01212         lan.<a class="code" href="structt__lan.html#o9">sts_new</a> = LAN_LNK_OFF;  <span class="comment">/* 処理遅延考慮で無条件にOFFに移行 */</span>
01213 
01214         PHY_int_ack();  <span class="comment">/* clear event */</span>
01215         lan.<a class="code" href="structt__lan.html#o1">lnk_chg</a> = 0;
01216     }<span class="keywordflow">else</span>{
01217         lan.<a class="code" href="structt__lan.html#o9">sts_new</a> = PHY_link();
01218     }
01219 
01220     <span class="keywordflow">if</span> (!(lan.<a class="code" href="structt__lan.html#o9">sts_new</a> ^ lan.<a class="code" href="structt__lan.html#o10">sts_old</a>)){ <span class="comment">/* same */</span>
01221         <span class="keywordflow">return</span>;
01222     }
01223     <span class="keywordflow">if</span> (lan.<a class="code" href="structt__lan.html#o9">sts_new</a> == LAN_LNK_OFF){   <span class="comment">/* LINK down */</span>
01224         lan_callback(lan.<a class="code" href="structt__lan.html#o9">sts_new</a>);
01225         <span class="keywordflow">return</span>;
01226     }
01227 
01228     <span class="keywordflow">switch</span>(lan.<a class="code" href="structt__lan.html#o9">sts_new</a>){
01229     <span class="keywordflow">case</span> LAN_LNK_100F:
01230     <span class="keywordflow">case</span> LAN_LNK_10F:  <span class="comment">/* FullDuplex */</span>
01231         <span class="keywordflow">if</span> (lan.<a class="code" href="structt__lan.html#o8">sts_mod</a> == LAN_LNK_100F || lan.<a class="code" href="structt__lan.html#o8">sts_mod</a> == LAN_LNK_10F){ <span class="comment">/* no change duplex */</span>
01232             lan.<a class="code" href="structt__lan.html#o8">sts_mod</a> = lan.<a class="code" href="structt__lan.html#o9">sts_new</a>;
01233             <span class="keywordflow">goto</span> exit_wakeup;
01234         }
01235         <span class="keywordflow">break</span>;
01236     <span class="keywordflow">case</span> LAN_LNK_100H:
01237     <span class="keywordflow">case</span> LAN_LNK_10H:  <span class="comment">/* HalfDuplex */</span>
01238         <span class="keywordflow">if</span> (lan.<a class="code" href="structt__lan.html#o8">sts_mod</a> == LAN_LNK_100H || lan.<a class="code" href="structt__lan.html#o8">sts_mod</a> == LAN_LNK_10H){ <span class="comment">/* no change duplex */</span>
01239             lan.<a class="code" href="structt__lan.html#o8">sts_mod</a> = lan.<a class="code" href="structt__lan.html#o9">sts_new</a>;
01240             <span class="keywordflow">goto</span> exit_wakeup;
01241         }
01242         <span class="keywordflow">break</span>;
01243     }
01244     lan.<a class="code" href="structt__lan.html#o8">sts_mod</a> = lan.<a class="code" href="structt__lan.html#o9">sts_new</a>;
01245 
01246     <span class="comment">/* stop sequence issue */</span>
01247     <span class="comment">/* re-start sequence issue */</span>
01248 
01249     lan_restart(lan.<a class="code" href="structt__lan.html#o9">sts_new</a>);            <span class="comment">/* re-start */</span>
01250 exit_wakeup:
01251     lan_callback(lan.<a class="code" href="structt__lan.html#o9">sts_new</a>);           <span class="comment">/* リンク状態通知コールバック */</span>
01252     <a class="code" href="lan9118_8c.html#a33">EI_PHYINT</a>();
01253 }
01254 
01255 <span class="preprocessor">#if NO_DMA</span>
01256 <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="lan9118_8c.html#a72">lan_dma_intr</a>(<span class="keywordtype">void</span>)
01257 {
01258     <span class="comment">/* dummy function */</span>
01259 }
01260 <span class="preprocessor">#else</span>
01261 <span class="preprocessor"></span><span class="comment">/*****************************************************************************</span>
01262 <span class="comment">* DMA転送再開(受信あれば)</span>
01263 <span class="comment">*</span>
01264 <span class="comment">******************************************************************************/</span>
01265 
01266 <span class="keyword">static</span> <span class="keywordtype">void</span> lan_dma_restart(<span class="keywordtype">void</span>)
01267 {
01268     UINT psw;
01269     UW len;
01270 
01271     psw = vdis_psw();
01272     <a class="code" href="lan9118_8c.html#a26">DI_RXINT</a>();         <span class="comment">/* Rx-INT 禁止 */</span>
01273     <span class="keywordflow">if</span> (<a class="code" href="nonethw_8c.html#a72">lan_dma_sts</a>()){ <span class="comment">/* DMA駆動中 */</span>
01274         vset_psw(psw);  <span class="comment">/* Restore INT-Level */</span>
01275         <span class="keywordflow">return</span>;
01276     }
01277     vset_psw(psw);
01278 
01279     <span class="comment">/* FIFO available ? */</span>
01280 
01281     <span class="keywordflow">while</span> (lan_rreg(RX_FIFO_INF) &amp; RINF_SUSED_MASK){
01282         <span class="keywordflow">if</span> (cRxBD-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o7">rx</a>.<a class="code" href="structt__bd.html#o4">ctl</a> &amp; RX_BD_RDY){
01283             dly_tick(3);
01284             len = cRxBD-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o7">rx</a>.<a class="code" href="structt__bd.html#o8">stat</a> = lan_rreg(RX_STAT);
01285             lan_wreg(INT_STS, DEF_RXINT);  <span class="comment">/* clear event */</span>
01286             len = cRxBD-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o7">rx</a>.<a class="code" href="structt__bd.html#o5">len</a> = (len &amp; RX_STS_LEN_MASK) &gt;&gt; RX_STS_LEN_SHFT;
01287             <span class="keywordflow">if</span> (ETHMINLEN &lt;= len &amp;&amp; len &lt;= ETHMAXLEN){
01288                 <a class="code" href="lan9118_8c.html#a22">RMON</a>(ERR_RXCNT);
01289                 <a class="code" href="lan9118_8c.html#a2">lan_indrep</a>(cRxBD-&gt;<a class="code" href="structt__bd.html#o0">buf</a>,ALIGN(len, BUFF_ALIGN)); <span class="comment">/* re-start */</span>
01290                 <span class="keywordflow">return</span>;
01291             }
01292 
01293             <a class="code" href="lan9118_8c.html#a22">RMON</a>(ERR_TOOLG);
01294             <span class="keywordflow">if</span> (len &lt; (4 * <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>))){
01295                 len = ALIGN(len, 4);
01296                 <span class="keywordflow">for</span> (; len != 0; len-=4)
01297                     lan_rreg(RX_DATA);  <span class="comment">/* dummy read for discard */</span>
01298             }else{
01299                 lan_wreg(RX_DP_CTL, RXDP_FFWD);  <span class="comment">/* skip ON */</span>
01300                 dly_tick(1);
01301                 <span class="keywordflow">while</span> (lan_rreg(RX_DP_CTL) &amp; RXDP_FFWD);  <span class="comment">/* wait until complete(about 20[usec]) */</span>
01302             }
01303         }
01304         <span class="keywordflow">else</span>{  <span class="comment">/* BD空きなし */</span>
01305             <a class="code" href="lan9118_8c.html#a22">RMON</a>(ERR_BDOV);
01306             <span class="keywordflow">return</span>;
01307         }
01308     }
01309     <a class="code" href="lan9118_8c.html#a27">EI_RXINT</a>();
01310 }
01311 
01312 <span class="comment">/*****************************************************************************</span>
01313 <span class="comment">* DMA interrupt service routine</span>
01314 <span class="comment">*</span>
01315 <span class="comment">******************************************************************************/</span>
01316 
<a name="l01317"></a><a class="code" href="nonethw_8c.html#a69">01317</a> <span class="keywordtype">void</span> <a class="code" href="lan9118_8c.html#a72">lan_dma_intr</a>(VP_INT exinf)
01318 {
01319     UW len;
01320     ID id;
01321 
01322 <span class="preprocessor">  #if (defined(BIG_ENDIAN) &amp;&amp; !BUS_SWAP)</span>
01323 <span class="preprocessor"></span>    <span class="keywordtype">int</span> i;
01324     UB *p, *q, pq;
01325 <span class="preprocessor">  #endif</span>
01326 <span class="preprocessor"></span>
01327     cRxBD-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o7">rx</a>.<a class="code" href="structt__bd.html#o4">ctl</a> &amp;= ~<a class="code" href="lan9118_8c.html#a13">RX_BD_RDY</a>;  <span class="comment">/* Data is available */</span>
01328 
01329 <span class="preprocessor">  #if (defined(BIG_ENDIAN) &amp;&amp; !BUS_SWAP)</span>
01330 <span class="preprocessor"></span>    p = (UB *)cRxBD-&gt;<a class="code" href="structt__bd.html#o0">buf</a>;
01331 <span class="preprocessor">  #endif</span>
01332 <span class="preprocessor"></span>
01333     <span class="comment">/* データ並び不一致なら、並び替え */</span>
01334 <span class="preprocessor">  #if (defined(BIG_ENDIAN) &amp;&amp; !BUS_SWAP)</span>
01335 <span class="preprocessor"></span>    q = p - 2;
01336     <span class="keywordflow">for</span> (i = ALIGN(cRxBD-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o7">rx</a>.<a class="code" href="structt__bd.html#o5">len</a>, <a class="code" href="lan9118_8c.html#a5">BUFF_ALIGN</a>); i &gt; 0; i -= 4) {
01337         q += 5;
01338         pq = *q;
01339         *q-- = *p;
01340         *p++ = pq;
01341         pq = *q;
01342         *q = *p;
01343         *p = pq;
01344         p += 3;
01345     }
01346 <span class="preprocessor">  #endif</span>
01347 <span class="preprocessor"></span>
01348     cRxBD = cRxBD-&gt;<a class="code" href="structt__bd.html#o6">next</a>;
01349 
01350     <span class="keywordflow">if</span> ((<span class="keywordtype">id</span> = lan.<a class="code" href="structt__lan.html#o7">rxtid</a>) != FALSE) {  <span class="comment">/* 受信割込み待ち中のタスクあるなら */</span>
01351         lan.<a class="code" href="structt__lan.html#o7">rxtid</a> = FALSE;
01352         wup_tsk(<span class="keywordtype">id</span>);                  <span class="comment">/* その(IP受信)タスクを起床 */</span>
01353     }
01354     <a class="code" href="nonethw_8c.html#a73">lan_dma_clr</a>();  <span class="comment">/* clear INT status */</span>
01355 
01356     <span class="comment">/* FIFO available ? */</span>
01357 
01358     <span class="keywordflow">while</span> (lan_rreg(RX_FIFO_INF) &amp; RINF_SUSED_MASK){
01359         <span class="keywordflow">if</span> (cRxBD-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o7">rx</a>.<a class="code" href="structt__bd.html#o4">ctl</a> &amp; <a class="code" href="lan9118_8c.html#a13">RX_BD_RDY</a>){
01360             dly_tick(3);
01361             len = cRxBD-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o7">rx</a>.<a class="code" href="structt__bd.html#o8">stat</a> = lan_rreg(RX_STAT);
01362             lan_wreg(INT_STS, <a class="code" href="lan9118_8c.html#a24">DEF_RXINT</a>);  <span class="comment">/* clear event */</span>
01363             len = cRxBD-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o7">rx</a>.<a class="code" href="structt__bd.html#o5">len</a> = (len &amp; RX_STS_LEN_MASK) &gt;&gt; RX_STS_LEN_SHFT;
01364             <span class="keywordflow">if</span> (<a class="code" href="lan9118_8c.html#a20">ETHMINLEN</a> &lt;= len &amp;&amp; len &lt;= <a class="code" href="lan9118_8c.html#a21">ETHMAXLEN</a>){
01365                 <a class="code" href="lan9118_8c.html#a22">RMON</a>(ERR_RXCNT);
01366                 <a class="code" href="lan9118_8c.html#a2">lan_indrep</a>(cRxBD-&gt;<a class="code" href="structt__bd.html#o0">buf</a>,ALIGN(len, <a class="code" href="lan9118_8c.html#a5">BUFF_ALIGN</a>)); <span class="comment">/* re-start */</span>
01367                 <span class="keywordflow">return</span>;
01368             }
01369 
01370             <a class="code" href="lan9118_8c.html#a22">RMON</a>(ERR_TOOLG);
01371             <span class="keywordflow">if</span> (len &lt; (4 * <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>))){
01372                 len = ALIGN(len, 4);
01373                 <span class="keywordflow">for</span> (; len != 0; len-=4)
01374                     lan_rreg(RX_DATA);  <span class="comment">/* dummy read for discard */</span>
01375             }<span class="keywordflow">else</span>{
01376                 lan_wreg(RX_DP_CTL, RXDP_FFWD);  <span class="comment">/* skip ON */</span>
01377                 dly_tick(1);
01378                 <span class="keywordflow">while</span> (lan_rreg(RX_DP_CTL) &amp; RXDP_FFWD);
01379             }
01380         }
01381         <span class="keywordflow">else</span>{  <span class="comment">/* BD空きなし */</span>
01382             <a class="code" href="lan9118_8c.html#a22">RMON</a>(ERR_BDOV);
01383             <span class="keywordflow">return</span>;
01384         }
01385     }
01386     <a class="code" href="lan9118_8c.html#a27">EI_RXINT</a>();
01387 }
01388 <span class="preprocessor">#endif</span>
01389 <span class="preprocessor"></span>
01390 <span class="comment">/*****************************************************************************</span>
01391 <span class="comment">* 送受信割込みサービスルーチン</span>
01392 <span class="comment">*</span>
01393 <span class="comment">******************************************************************************/</span>
01394 
<a name="l01395"></a><a class="code" href="nonethw_8c.html#a68">01395</a> <span class="keywordtype">void</span> <a class="code" href="lan9118_8c.html#a73">lan_intr</a>(VP_INT exinf)
01396 {
01397     UW len;
01398     UW ist, mask;
01399     ID id;
01400 
01401     dly_tick(1);               <span class="comment">/* read after INT_EN write delay(高速プロセッサ考慮) */</span>
01402     mask = lan_rreg(INT_EN);
01403     <span class="keywordflow">if</span> (!mask)                 <span class="comment">/* 割込み禁止レイテンシ対策(valid after write delay) */</span>
01404         <span class="keywordflow">return</span>;
01405 
01406     ist = lan_rreg(INT_STS);   <span class="comment">/* get interrupt status */</span>
01407     ist &amp;= mask;
01408 
01409 <span class="preprocessor">  #ifdef RX_MONITOR</span>
01410 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ist &amp; INT_RXDF){
01411         lan.err_count[ERR_DROP] += lan_rreg(RX_DROP);
01412     }
01413 <span class="preprocessor">  #endif</span>
01414 <span class="preprocessor"></span>
01415     <span class="keywordflow">if</span> (ist &amp; <a class="code" href="lan9118_8c.html#a24">DEF_RXINT</a>) {
01416 <span class="preprocessor">  #if NO_DMA</span>
01417 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((<span class="keywordtype">id</span> = lan.<a class="code" href="structt__lan.html#o7">rxtid</a>) != FALSE) {  <span class="comment">/* 受信割込み待ち中のタスクあるなら */</span>
01418             lan.<a class="code" href="structt__lan.html#o7">rxtid</a> = FALSE;
01419             wup_tsk(<span class="keywordtype">id</span>);                  <span class="comment">/* その(IP受信)タスクを起床 */</span>
01420         }
01421         mask &amp;= ~<a class="code" href="lan9118_8c.html#a24">DEF_RXINT</a>;
01422 <span class="preprocessor">  #else</span>
01423 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (lan_rreg(RX_FIFO_INF) &amp; RINF_SUSED_MASK){
01424             <a class="code" href="lan9118_8c.html#a22">RMON</a>(ERR_RXINT);
01425 
01426             <span class="keywordflow">if</span> (cRxBD-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o7">rx</a>.<a class="code" href="structt__bd.html#o4">ctl</a> &amp; <a class="code" href="lan9118_8c.html#a13">RX_BD_RDY</a>){   <span class="comment">/* BD有効 */</span>
01427                 dly_tick(3);
01428                 len = cRxBD-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o7">rx</a>.<a class="code" href="structt__bd.html#o8">stat</a> = lan_rreg(RX_STAT);
01429                 len = cRxBD-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o7">rx</a>.<a class="code" href="structt__bd.html#o5">len</a> = (len &amp; RX_STS_LEN_MASK) &gt;&gt; RX_STS_LEN_SHFT;
01430                 <span class="keywordflow">if</span> (<a class="code" href="lan9118_8c.html#a20">ETHMINLEN</a> &lt;= len &amp;&amp; len &lt;= <a class="code" href="lan9118_8c.html#a21">ETHMAXLEN</a>){
01431                     <a class="code" href="lan9118_8c.html#a22">RMON</a>(ERR_RXCNT);
01432                     mask &amp;= ~<a class="code" href="lan9118_8c.html#a24">DEF_RXINT</a>;
01433                     <a class="code" href="lan9118_8c.html#a2">lan_indrep</a>(cRxBD-&gt;<a class="code" href="structt__bd.html#o0">buf</a>,ALIGN(len, <a class="code" href="lan9118_8c.html#a5">BUFF_ALIGN</a>)); <span class="comment">/* start DMA */</span>
01434                 }
01435                 <span class="keywordflow">else</span>{
01436                     <a class="code" href="lan9118_8c.html#a22">RMON</a>(ERR_TOOLG);
01437                     <span class="keywordflow">if</span> (len &lt; (4 * <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>))){
01438                         len = ALIGN(len, 4);
01439                         <span class="keywordflow">for</span> (; len != 0; len-=4)
01440                             lan_rreg(RX_DATA);  <span class="comment">/* dummy read for discard */</span>
01441                     }<span class="keywordflow">else</span>{
01442                         lan_wreg(RX_DP_CTL, RXDP_FFWD);  <span class="comment">/* skip ON */</span>
01443                         dly_tick(1);
01444                         <span class="keywordflow">while</span> (lan_rreg(RX_DP_CTL) &amp; RXDP_FFWD);
01445                     }
01446                 }
01447             }
01448             <span class="keywordflow">else</span>{  <span class="comment">/* BD空きなし */</span>
01449                 <a class="code" href="lan9118_8c.html#a22">RMON</a>(ERR_BDOV);
01450                 <span class="keywordflow">if</span> ((<span class="keywordtype">id</span> = lan.<a class="code" href="structt__lan.html#o7">rxtid</a>) != FALSE) {  <span class="comment">/* 受信割込み待ち中のタスクあるなら */</span>
01451                     lan.<a class="code" href="structt__lan.html#o7">rxtid</a> = FALSE;
01452                     wup_tsk(<span class="keywordtype">id</span>);                  <span class="comment">/* その(IP受信)タスクを起床 */</span>
01453                 }
01454                 mask &amp;= ~<a class="code" href="lan9118_8c.html#a24">DEF_RXINT</a>;
01455             }
01456         }
01457 <span class="preprocessor">  #endif</span>
01458 <span class="preprocessor"></span>    }
01459 
01460     <span class="comment">/* 送信割込み */</span>
01461 
01462     <span class="keywordflow">if</span> (ist &amp; <a class="code" href="lan9118_8c.html#a25">DEF_TXINT</a>) {                <span class="comment">/* transmit interrupt */</span>
01463         <span class="keywordflow">if</span> ((<span class="keywordtype">id</span> = lan.<a class="code" href="structt__lan.html#o14">txtid</a>) != FALSE) {  <span class="comment">/* 送信割込み待ち中のタスクあるなら */</span>
01464             lan.<a class="code" href="structt__lan.html#o14">txtid</a> = FALSE;
01465             wup_tsk(<span class="keywordtype">id</span>);                  <span class="comment">/* その(IP送信)タスクを起床 */</span>
01466         }
01467         mask &amp;= ~<a class="code" href="lan9118_8c.html#a25">DEF_TXINT</a>;
01468     }
01469 
01470     <span class="comment">/* PHY events (there use only LINK status) */</span>
01471 
01472     <span class="keywordflow">if</span> (ist &amp; INT_PHY) {
01473         lan.<a class="code" href="structt__lan.html#o1">lnk_chg</a> = 1;
01474         <span class="keywordflow">if</span> ((<span class="keywordtype">id</span> = lan.<a class="code" href="structt__lan.html#o7">rxtid</a>) != FALSE) {  <span class="comment">/* 受信割込み待ち中のタスクあるなら */</span>
01475             lan.<a class="code" href="structt__lan.html#o7">rxtid</a> = FALSE;
01476             wup_tsk(<span class="keywordtype">id</span>);                  <span class="comment">/* その(IP受信)タスクを起床 */</span>
01477         }
01478         mask &amp;= ~INT_PHY;
01479     }
01480     lan_wreg(INT_EN, lan.<a class="code" href="structt__lan.html#o3">mask</a> = mask);
01481     lan_wreg(INT_STS, ist);  <span class="comment">/* clear event */</span>
01482 }
01483 
01484 <span class="preprocessor">#if NO_DMA</span>
01485 <span class="preprocessor"></span><span class="comment">/*****************************************************************************</span>
01486 <span class="comment">* Get FIFO data</span>
01487 <span class="comment">*</span>
01488 <span class="comment">******************************************************************************/</span>
01489 
01490 <span class="keyword">static</span> <span class="keywordtype">void</span> get_rfifo(<span class="keywordtype">void</span>)
01491 {
01492     UW len;
01493 
01494     <span class="comment">/* FIFO available ? */</span>
01495 
01496     <span class="keywordflow">while</span> (lan_rreg(RX_FIFO_INF) &amp; RINF_SUSED_MASK){
01497         <span class="keywordflow">if</span> (cRxBD-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o7">rx</a>.<a class="code" href="structt__bd.html#o4">ctl</a> &amp; RX_BD_RDY){
01498             dly_tick(3);
01499             len = cRxBD-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o7">rx</a>.<a class="code" href="structt__bd.html#o8">stat</a> = lan_rreg(RX_STAT);
01500             lan_wreg(INT_STS, DEF_RXINT);  <span class="comment">/* clear event */</span>
01501             len = cRxBD-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o7">rx</a>.<a class="code" href="structt__bd.html#o5">len</a> = (len &amp; RX_STS_LEN_MASK) &gt;&gt; RX_STS_LEN_SHFT;
01502             <span class="keywordflow">if</span> (ETHMINLEN &lt;= len &amp;&amp; len &lt;= ETHMAXLEN){
01503                 <a class="code" href="lan9118_8c.html#a22">RMON</a>(ERR_RXCNT);
01504                 <a class="code" href="lan9118_8c.html#a2">lan_indrep</a>((UW *)cRxBD-&gt;<a class="code" href="structt__bd.html#o0">buf</a>, ALIGN(len, BUFF_ALIGN));
01505                 cRxBD-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o7">rx</a>.<a class="code" href="structt__bd.html#o4">ctl</a> &amp;= ~<a class="code" href="lan9118_8c.html#a13">RX_BD_RDY</a>;  <span class="comment">/* Data is available */</span>
01506                 cRxBD = cRxBD-&gt;<a class="code" href="structt__bd.html#o6">next</a>;
01507             }
01508             <span class="keywordflow">else</span>{
01509                 <a class="code" href="lan9118_8c.html#a22">RMON</a>(ERR_TOOLG);
01510                 <span class="keywordflow">if</span> (len &lt; (4 * <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>))){
01511                     len = ALIGN(len, 4);
01512                     <span class="keywordflow">for</span> (; len != 0; len-=4)
01513                         lan_rreg(RX_DATA);  <span class="comment">/* dummy read for discard */</span>
01514                 }else{
01515                     lan_wreg(RX_DP_CTL, RXDP_FFWD);  <span class="comment">/* skip ON */</span>
01516                     dly_tick(1);
01517                     <span class="keywordflow">while</span> (lan_rreg(RX_DP_CTL) &amp; RXDP_FFWD);
01518                 }
01519             }
01520         }
01521         <span class="keywordflow">else</span>{  <span class="comment">/* BD空きなし */</span>
01522             <a class="code" href="lan9118_8c.html#a22">RMON</a>(ERR_BDOV);
01523             <span class="keywordflow">break</span>;
01524         }
01525     }
01526 }
01527 <span class="preprocessor">#endif</span>
01528 <span class="preprocessor"></span>
01529 <span class="comment">/*****************************************************************************</span>
01530 <span class="comment">* 受信割込み待ち</span>
01531 <span class="comment">*</span>
01532 <span class="comment">******************************************************************************/</span>
01533 
<a name="l01534"></a><a class="code" href="lan9118_8c.html#a74">01534</a> ER <a class="code" href="lan9118_8c.html#a74">lan_wai_rcv</a>(TMO tmout)
01535 {
01536     ER ercd = E_OK;
01537     TMO delay;
01538 
01539     <span class="keywordflow">for</span> (;;){
01540 <span class="preprocessor">  #if NO_DMA</span>
01541 <span class="preprocessor"></span>        get_rfifo();     <span class="comment">/* RX-FIFO読出し */</span>
01542 <span class="preprocessor">  #endif</span>
01543 <span class="preprocessor"></span>
01544         <span class="keywordflow">if</span> (!(pRxBD-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o7">rx</a>.<a class="code" href="structt__bd.html#o4">ctl</a> &amp; <a class="code" href="lan9118_8c.html#a13">RX_BD_RDY</a>) &amp;&amp; !lan.<a class="code" href="structt__lan.html#o1">lnk_chg</a>){
01545                                               <span class="comment">/* LINK Down検出ならそれを優先する */</span>
01546             <span class="keywordflow">if</span> (!(pRxBD-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o7">rx</a>.<a class="code" href="structt__bd.html#o8">stat</a> &amp; RX_STS_ES)){
01547                 <span class="keywordflow">if</span> (pRxBD-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o7">rx</a>.<a class="code" href="structt__bd.html#o5">len</a> &gt;= 4)
01548                     pRxBD-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o7">rx</a>.<a class="code" href="structt__bd.html#o5">len</a> -= 4;  <span class="comment">/* CRC分引く */</span>
01549 
01550                 lan.<a class="code" href="structt__lan.html#o5">rxbd</a>  = pRxBD;       <span class="comment">/* set current RxBD for working */</span>
01551                 lan.<a class="code" href="structt__lan.html#o6">rxbuf</a> = pRxBD-&gt;<a class="code" href="structt__bd.html#o0">buf</a>;  <span class="comment">/* set current buffer for working */</span>
01552                 pRxBD = pRxBD-&gt;<a class="code" href="structt__bd.html#o6">next</a>;     <span class="comment">/* set next BD to current */</span>
01553                 <span class="keywordflow">return</span> E_OK;
01554             }
01555             <a class="code" href="lan9118_8c.html#a22">RMON</a>(ERR_ERSTAT);
01556 
01557             pRxBD-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o7">rx</a>.<a class="code" href="structt__bd.html#o4">ctl</a> = <a class="code" href="lan9118_8c.html#a13">RX_BD_RDY</a>;
01558             pRxBD = pRxBD-&gt;<a class="code" href="structt__bd.html#o6">next</a>;
01559             <a class="code" href="lan9118_8c.html#a30">RX_RESTART</a>();
01560             <span class="keywordflow">continue</span>;
01561         }
01562 
01563         lan.<a class="code" href="structt__lan.html#o7">rxtid</a> = (UH)vget_tid();
01564 
01565         <span class="keywordflow">if</span> (lan.<a class="code" href="structt__lan.html#o1">lnk_chg</a> || lan.<a class="code" href="structt__lan.html#o9">sts_new</a> == LAN_LNK_OFF)
01566             lan_link();
01567 
01568         <span class="comment">/* LINK UP はポーリングで監視 */</span>
01569         <span class="keywordflow">if</span> (lan.<a class="code" href="structt__lan.html#o9">sts_new</a> == LAN_LNK_OFF){
01570             <span class="keywordflow">if</span> (tmout == TMO_FEVR){
01571                 delay = <a class="code" href="lan9118_8c.html#a7">LINK_TIME</a>;
01572             }<span class="keywordflow">else</span>{
01573                 <span class="keywordflow">if</span> (!tmout)
01574                     <span class="keywordflow">return</span> E_TMOUT;
01575                 delay = (tmout &lt; <a class="code" href="lan9118_8c.html#a7">LINK_TIME</a>) ? tmout : <a class="code" href="lan9118_8c.html#a7">LINK_TIME</a>;
01576                 tmout -= delay;
01577             }
01578         }<span class="keywordflow">else</span>{
01579             delay = tmout;
01580         }
01581 
01582         <span class="comment">/* 受信待ち */</span>
01583 
01584 <span class="preprocessor">  #if NO_DMA</span>
01585 <span class="preprocessor"></span>        <a class="code" href="lan9118_8c.html#a27">EI_RXINT</a>();                     <span class="comment">/* 受信割込み許可 */</span>
01586 <span class="preprocessor">  #else</span>
01587 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!(pRxBD-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o7">rx</a>.<a class="code" href="structt__bd.html#o4">ctl</a> &amp; <a class="code" href="lan9118_8c.html#a13">RX_BD_RDY</a>)){ <span class="comment">/* rxtid取得前に受信INTあれば */</span>
01588             lan.<a class="code" href="structt__lan.html#o7">rxtid</a> = FALSE;
01589             <span class="keywordflow">continue</span>;                          <span class="comment">/* やり直し */</span>
01590         }
01591 <span class="preprocessor">  #endif</span>
01592 <span class="preprocessor"></span>        ercd = tslp_tsk(delay);         <span class="comment">/* 受信割込みからの起床待ち */</span>
01593 <span class="preprocessor">  #if NO_DMA</span>
01594 <span class="preprocessor"></span>        <a class="code" href="lan9118_8c.html#a26">DI_RXINT</a>();                     <span class="comment">/* 受信割込み禁止 */</span>
01595 <span class="preprocessor">  #endif</span>
01596 <span class="preprocessor"></span>        lan.<a class="code" href="structt__lan.html#o7">rxtid</a> = FALSE;
01597         vcan_wup();
01598 
01599         <span class="keywordflow">if</span> (!(ercd == E_OK || ercd == E_TMOUT))
01600             <span class="keywordflow">break</span>;
01601     }
01602     <span class="keywordflow">return</span> ercd;
01603 }
01604 
01605 <span class="comment">/*****************************************************************************</span>
01606 <span class="comment">* 送信割込み待ち</span>
01607 <span class="comment">*</span>
01608 <span class="comment">******************************************************************************/</span>
01609 
<a name="l01610"></a><a class="code" href="lan9118_8c.html#a75">01610</a> ER <a class="code" href="lan9118_8c.html#a75">lan_wai_snd</a>(TMO tmout)
01611 {
01612     ER ercd = E_OK;
01613 
01614     <span class="keywordflow">for</span> (;;){
01615         <span class="keywordflow">if</span> ((lan_rreg(TX_FIFO_INF) &amp; TINF_DFREE_MASK) &gt;= (<a class="code" href="lan9118_8c.html#a21">ETHMAXLEN</a>+8)){  <span class="comment">/* FIFOに空きあり */</span>
01616             <span class="comment">/* 待ち要因ある場合は今後のTCP/IP仕様考慮でlan_wai_snd()に集約する。</span>
01617 <span class="comment">             * でも、ここでは、length分からないので、最大長でチェックする。</span>
01618 <span class="comment">             * 2006.11.27 [OK]</span>
01619 <span class="comment">             */</span>
01620             <span class="keywordflow">if</span> (!(pTxBD-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o9">tx</a>.<a class="code" href="structt__bd.html#o2">cmd_b</a> &amp; TX_CMDB_TAG_MASK)){  <span class="comment">/* Tx OK */</span>
01621                 lan.<a class="code" href="structt__lan.html#o13">txtag</a>++;
01622                 <span class="keywordflow">if</span> (!lan.<a class="code" href="structt__lan.html#o13">txtag</a>)
01623                     lan.<a class="code" href="structt__lan.html#o13">txtag</a>++;
01624                 pTxBD-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o9">tx</a>.<a class="code" href="structt__bd.html#o2">cmd_b</a> = ((UW)lan.<a class="code" href="structt__lan.html#o13">txtag</a>) &lt;&lt;16;  <span class="comment">/* BD is not empty */</span>
01625                 lan.<a class="code" href="structt__lan.html#o11">txbd</a>  = pTxBD;
01626                 lan.<a class="code" href="structt__lan.html#o12">txbuf</a> = pTxBD-&gt;<a class="code" href="structt__bd.html#o0">buf</a>;
01627                 pTxBD = pTxBD-&gt;<a class="code" href="structt__bd.html#o6">next</a>;
01628                 <span class="keywordflow">return</span> E_OK;
01629             }
01630         }
01631 
01632         lan.<a class="code" href="structt__lan.html#o14">txtid</a> = (UH)vget_tid();
01633         <a class="code" href="lan9118_8c.html#a32">EI_TXINT</a>();
01634         ercd = tslp_tsk(tmout);
01635         <a class="code" href="lan9118_8c.html#a31">DI_TXINT</a>();
01636         lan.<a class="code" href="structt__lan.html#o14">txtid</a> = FALSE;
01637         vcan_wup();
01638         <span class="keywordflow">if</span> (ercd != E_OK)
01639             <span class="keywordflow">break</span>;
01640     }
01641     <span class="keywordflow">return</span> ercd;
01642 }
01643 
01644 <span class="comment">/*****************************************************************************</span>
01645 <span class="comment">* 受信パケット長を得る</span>
01646 <span class="comment">*</span>
01647 <span class="comment">******************************************************************************/</span>
01648 
<a name="l01649"></a><a class="code" href="lan9118_8c.html#a76">01649</a> ER <a class="code" href="lan9118_8c.html#a76">lan_get_len</a>(UH *len)
01650 {
01651     *len = lan.<a class="code" href="structt__lan.html#o5">rxbd</a>-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o7">rx</a>.<a class="code" href="structt__bd.html#o5">len</a>;
01652     <span class="keywordflow">return</span> E_OK;
01653 }
01654 
01655 <span class="comment">/*****************************************************************************</span>
01656 <span class="comment">* 受信パケット読み出し</span>
01657 <span class="comment">*</span>
01658 <span class="comment">* buf   読み出すためのバッファ</span>
01659 <span class="comment">* len   読み出すバイト数</span>
01660 <span class="comment">******************************************************************************/</span>
01661 
<a name="l01662"></a><a class="code" href="lan9118_8c.html#a77">01662</a> ER <a class="code" href="lan9118_8c.html#a77">lan_get_pkt</a>(<span class="keywordtype">void</span> *buf, <span class="keywordtype">int</span> len)
01663 {
01664     memcpy(buf, lan.<a class="code" href="structt__lan.html#o6">rxbuf</a>, len);
01665     lan.<a class="code" href="structt__lan.html#o6">rxbuf</a> += len;
01666     <span class="keywordflow">return</span> E_OK;
01667 }
01668 
01669 <span class="comment">/*****************************************************************************</span>
01670 <span class="comment">* 受信パケット読み出し終了</span>
01671 <span class="comment">*</span>
01672 <span class="comment">******************************************************************************/</span>
01673 
<a name="l01674"></a><a class="code" href="lan9118_8c.html#a78">01674</a> ER <a class="code" href="lan9118_8c.html#a78">lan_get_end</a>(<span class="keywordtype">void</span>)
01675 {
01676     lan.<a class="code" href="structt__lan.html#o5">rxbd</a>-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o7">rx</a>.<a class="code" href="structt__bd.html#o4">ctl</a> = <a class="code" href="lan9118_8c.html#a13">RX_BD_RDY</a>;
01677     <a class="code" href="lan9118_8c.html#a30">RX_RESTART</a>();
01678     <span class="keywordflow">return</span> E_OK;
01679 }
01680 
01681 <span class="comment">/*****************************************************************************</span>
01682 <span class="comment">* 受信パケット読み飛ばし</span>
01683 <span class="comment">*</span>
01684 <span class="comment">* len   受信パケットの未読バイト数</span>
01685 <span class="comment">******************************************************************************/</span>
01686 
<a name="l01687"></a><a class="code" href="lan9118_8c.html#a79">01687</a> ER <a class="code" href="lan9118_8c.html#a79">lan_skp_pkt</a>(<span class="keywordtype">int</span> len)
01688 {
01689     <span class="keywordflow">return</span> <a class="code" href="lan9118_8c.html#a78">lan_get_end</a>();
01690 }
01691 
01692 <span class="comment">/*****************************************************************************</span>
01693 <span class="comment">* 送信パケット長を設定</span>
01694 <span class="comment">*</span>
01695 <span class="comment">******************************************************************************/</span>
01696 
<a name="l01697"></a><a class="code" href="lan9118_8c.html#a80">01697</a> ER <a class="code" href="lan9118_8c.html#a80">lan_set_len</a>(<span class="keywordtype">int</span> len)
01698 {
01699     <span class="comment">/* Transfer Command-A */</span>
01700     lan.<a class="code" href="structt__lan.html#o11">txbd</a>-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o9">tx</a>.<a class="code" href="structt__bd.html#o1">cmd_a</a> = len |(TX_CMDA_IOC|<a class="code" href="lan9118_8c.html#a18">TX_CMDA_EA</a>|TX_CMDA_F|TX_CMDA_L);
01701 
01702     <span class="comment">/* Transfer Command-B */</span>
01703     lan.<a class="code" href="structt__lan.html#o11">txbd</a>-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o9">tx</a>.<a class="code" href="structt__bd.html#o2">cmd_b</a> |= len;
01704 
01705     <span class="keywordflow">return</span> E_OK;
01706 }
01707 
01708 <span class="comment">/*****************************************************************************</span>
01709 <span class="comment">* 送信パケット書き込み</span>
01710 <span class="comment">*</span>
01711 <span class="comment">* data      書き込むデータ</span>
01712 <span class="comment">* len       データのバイト数（&gt; 0）</span>
01713 <span class="comment">******************************************************************************/</span>
01714 
<a name="l01715"></a><a class="code" href="lan9118_8c.html#a81">01715</a> ER <a class="code" href="lan9118_8c.html#a81">lan_put_pkt</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> len)
01716 {
01717     memcpy(lan.<a class="code" href="structt__lan.html#o12">txbuf</a>, data, len);
01718     lan.<a class="code" href="structt__lan.html#o12">txbuf</a> += len;
01719     <span class="keywordflow">return</span> E_OK;
01720 }
01721 
01722 <span class="comment">/*****************************************************************************</span>
01723 <span class="comment">* 送信パケットが60バイト未満の場合のダミー書き込み</span>
01724 <span class="comment">*</span>
01725 <span class="comment">* len       ダミーデータのバイト数（&gt; 0）</span>
01726 <span class="comment">******************************************************************************/</span>
01727 
<a name="l01728"></a><a class="code" href="lan9118_8c.html#a82">01728</a> ER <a class="code" href="lan9118_8c.html#a82">lan_put_dmy</a>(<span class="keywordtype">int</span> len)
01729 {
01730     memset(lan.<a class="code" href="structt__lan.html#o12">txbuf</a>, 0, len);
01731     lan.<a class="code" href="structt__lan.html#o12">txbuf</a> += len;
01732 
01733     <span class="keywordflow">return</span> E_OK;
01734 }
01735 
01736 <span class="comment">/*****************************************************************************</span>
01737 <span class="comment">* 送信パケット書き込み終了</span>
01738 <span class="comment">*</span>
01739 <span class="comment">******************************************************************************/</span>
01740 
<a name="l01741"></a><a class="code" href="lan9118_8c.html#a83">01741</a> ER <a class="code" href="lan9118_8c.html#a83">lan_put_end</a>(<span class="keywordtype">void</span>)
01742 {
01743     UW len;
01744 
01745     <span class="keywordflow">if</span> (lan.<a class="code" href="structt__lan.html#o9">sts_new</a> == LAN_LNK_OFF){  <span class="comment">/* Discarded if LAN is LINK Down */</span>
01746         lan.<a class="code" href="structt__lan.html#o11">txbd</a>-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o9">tx</a>.<a class="code" href="structt__bd.html#o2">cmd_b</a> &amp;= ~TX_CMDB_TAG_MASK; <span class="comment">/* BD ready */</span>
01747         <span class="keywordflow">return</span> E_OK;
01748     }
01749 
01750     len = lan.<a class="code" href="structt__lan.html#o11">txbd</a>-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o9">tx</a>.<a class="code" href="structt__bd.html#o2">cmd_b</a> &amp; TX_CMDB_LEN_MASK;
01751 
01752     <span class="comment">/* Set from buffer to TX-FIFO */</span>
01753 
01754     lan_wreg(TX_DATA, lan.<a class="code" href="structt__lan.html#o11">txbd</a>-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o9">tx</a>.<a class="code" href="structt__bd.html#o1">cmd_a</a>);
01755     lan_wreg(TX_DATA, lan.<a class="code" href="structt__lan.html#o11">txbd</a>-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o9">tx</a>.<a class="code" href="structt__bd.html#o2">cmd_b</a>);
01756     lan_outdrep((UW *)lan.<a class="code" href="structt__lan.html#o11">txbd</a>-&gt;<a class="code" href="structt__bd.html#o0">buf</a>, ALIGN(len, <a class="code" href="lan9118_8c.html#a5">BUFF_ALIGN</a>));  <span class="comment">/* Transfer data */</span>
01757 
01758     lan.<a class="code" href="structt__lan.html#o11">txbd</a>-&gt;<a class="code" href="structt__bd.html#o3">csr</a>.<a class="code" href="structt__bd.html#o9">tx</a>.<a class="code" href="structt__bd.html#o2">cmd_b</a> &amp;= ~TX_CMDB_TAG_MASK; <span class="comment">/* BD ready */</span>
01759     <span class="keywordflow">return</span> E_OK;
01760 }
01761 
01762 <span class="comment">/*****************************************************************************</span>
01763 <span class="comment">* コールバック関数登録</span>
01764 <span class="comment">*</span>
01765 <span class="comment">******************************************************************************/</span>
01766 
<a name="l01767"></a><a class="code" href="lan9118_8c.html#a84">01767</a> ER <a class="code" href="lan9118_8c.html#a84">lan_def_cbk</a>(FP func)
01768 {
01769     lan.<a class="code" href="structt__lan.html#o0">callback</a> = func;
01770     callbackini = func;
01771     <span class="keywordflow">return</span> E_OK;
01772 }
01773 
01774 <span class="preprocessor">#if BUG_10BASE_POL</span>
01775 <span class="preprocessor"></span><span class="comment">/*****************************************************************************</span>
01776 <span class="comment">* テストフレーム送信 for LOOPBACK</span>
01777 <span class="comment">*</span>
01778 <span class="comment">******************************************************************************/</span>
01779 
<a name="l01780"></a><a class="code" href="lan9118_8c.html#a85">01780</a> ER <a class="code" href="lan9118_8c.html#a85">lan_tst_snd</a>(<span class="keywordtype">void</span>)
01781 {
01782     UW i,d;
01783     UW len = 1512;  <span class="comment">/* maximum by align 4 */</span>
01784 
01785     <span class="comment">/* Transfer Command-A */</span>
01786     lan_wreg(TX_DATA, len |(<a class="code" href="lan9118_8c.html#a18">TX_CMDA_EA</a>|TX_CMDA_F|TX_CMDA_L));
01787 
01788     <span class="comment">/* Transfer Command-B */</span>
01789     lan_wreg(TX_DATA, len);
01790 
01791     <span class="comment">/* Transfer Data */</span>
01792     d = 0x00010203;
01793     len = ALIGN(len, <a class="code" href="lan9118_8c.html#a5">BUFF_ALIGN</a>);
01794     <span class="keywordflow">for</span> (i = 0; i &lt; len/4; i++, d += 0x04040404)
01795         lan_outd(TX_DATA, d);
01796 
01797     <span class="keywordflow">return</span> E_OK;
01798 }
01799 
01800 <span class="comment">/*****************************************************************************</span>
01801 <span class="comment">* テストフレーム受信 for LOOPBACK</span>
01802 <span class="comment">*</span>
01803 <span class="comment">******************************************************************************/</span>
01804 
<a name="l01805"></a><a class="code" href="lan9118_8c.html#a86">01805</a> ER <a class="code" href="lan9118_8c.html#a86">lan_tst_rcv</a>(<span class="keywordtype">void</span>)
01806 {
01807     UW i,d;
01808     UW len;
01809     UW len2;
01810     ER ercd = E_OK;
01811 
01812     <span class="keywordflow">while</span> (!(lan_rreg(RX_FIFO_INF) &amp; RINF_SUSED_MASK));
01813     dly_tick(3);
01814 
01815     len = lan_rreg(RX_STAT);
01816     len = (len &amp; RX_STS_LEN_MASK) &gt;&gt; RX_STS_LEN_SHFT;
01817     <span class="keywordflow">if</span> (len != 1512+4){
01818         <span class="keywordflow">if</span> (len &lt; (4 * <span class="keyword">sizeof</span>(<span class="keywordtype">long</span>))){
01819             len = ALIGN(len, 4);
01820             <span class="keywordflow">for</span> (; len != 0; len-=4)
01821                 lan_ind(RX_DATA);  <span class="comment">/* dummy read for discard */</span>
01822         }<span class="keywordflow">else</span>{
01823             lan_wreg(RX_DP_CTL, RXDP_FFWD);  <span class="comment">/* skip ON */</span>
01824             dly_tick(1);
01825             <span class="keywordflow">while</span> (lan_rreg(RX_DP_CTL) &amp; RXDP_FFWD);
01826         }
01827         <span class="keywordflow">return</span> -1;
01828     }
01829 
01830     len2 = ALIGN(len, <a class="code" href="lan9118_8c.html#a5">BUFF_ALIGN</a>) - len;
01831     len -=4;
01832     d = 0x00010203;
01833     <span class="keywordflow">for</span> (i = 0; i &lt; len/4; i++, d += 0x04040404)
01834         <span class="keywordflow">if</span> (lan_ind(RX_DATA) != d)
01835             ercd = -1;
01836 
01837     lan_ind(RX_DATA);  <span class="comment">/* discard FCS */</span>
01838 
01839     len = ALIGN(len2, 4);
01840     <span class="keywordflow">for</span> (; len != 0; len-=4)
01841         lan_rreg(RX_DATA);  <span class="comment">/* dummy read for discard */</span>
01842 
01843     <span class="keywordflow">return</span> ercd;
01844 }
01845 <span class="preprocessor">#endif</span>
01846 <span class="preprocessor"></span>
01847 <span class="comment">/*****************************************************************************</span>
01848 <span class="comment">* シリアルEEPROM 1バイト読み出し</span>
01849 <span class="comment">*</span>
01850 <span class="comment">* シリアルEEPROMから1バイトのデータを読み出す。</span>
01851 <span class="comment">* 読み出し成功でE_OK、失敗でE_TMOUTを返す。</span>
01852 <span class="comment">******************************************************************************/</span>
01853 
<a name="l01854"></a><a class="code" href="lan9118_8c.html#a87">01854</a> ER <a class="code" href="lan9118_8c.html#a87">lan_get_eep</a>(UB addr,       <span class="comment">/* EEPROM WORD ADDRESS */</span>
01855                UB *data)      <span class="comment">/* 読み出したデータ */</span>
01856 {
01857     UW sts;
01858 
01859     <span class="keywordflow">while</span> (lan_rreg(E2P_CMD) &amp; E2P_BUSY);
01860     lan_wreg(E2P_CMD, E2P_BUSY|E2P_READ|(UW)addr);
01861     dly_tick(1);
01862     <span class="keywordflow">while</span> ((sts = lan_rreg(E2P_CMD)) &amp; E2P_BUSY);
01863     <span class="keywordflow">if</span> (sts &amp; E2P_TMO)
01864         <span class="keywordflow">return</span> E_TMOUT;
01865     <span class="keywordflow">else</span>
01866         *data = (UB)lan_rreg(E2P_DATA);
01867 
01868     <span class="keywordflow">return</span> E_OK;
01869 }
01870 
01871 <span class="comment">/*****************************************************************************</span>
01872 <span class="comment">* シリアルEEPROM 1バイト書き込み</span>
01873 <span class="comment">*</span>
01874 <span class="comment">* シリアルEEPROMに1バイトのデータを書き込む。</span>
01875 <span class="comment">* 書き込み成功でE_OK、失敗でE_TMOUTを返す。</span>
01876 <span class="comment">******************************************************************************/</span>
01877 
<a name="l01878"></a><a class="code" href="lan9118_8c.html#a88">01878</a> ER <a class="code" href="lan9118_8c.html#a88">lan_set_eep</a>(UB addr,  <span class="comment">/* EEPROM WORD ADDRESS */</span>
01879                UB data)  <span class="comment">/* 書き込むデータ */</span>
01880 {
01881     ER ercd = E_OK;
01882     UW sts;
01883 
01884     <span class="keywordflow">while</span> (lan_rreg(E2P_CMD) &amp; E2P_BUSY);
01885     lan_wreg(E2P_CMD, E2P_BUSY|E2P_EWEN);  <span class="comment">/* write enable */</span>
01886     dly_tick(1);
01887     <span class="keywordflow">while</span> (lan_rreg(E2P_CMD) &amp; E2P_BUSY);
01888 
01889     lan_wreg(E2P_DATA, (UW)data);
01890     lan_wreg(E2P_CMD, E2P_BUSY|E2P_WRITE|(UW)addr);
01891     dly_tick(1);
01892     <span class="keywordflow">while</span> ((sts = lan_rreg(E2P_CMD)) &amp; E2P_BUSY);
01893     <span class="keywordflow">if</span> (sts &amp; E2P_TMO)
01894         ercd = E_TMOUT;
01895 
01896     lan_wreg(E2P_CMD, E2P_BUSY|E2P_EWDS);  <span class="comment">/* write disable */</span>
01897     <span class="keywordflow">return</span> ercd;
01898 }
01899 
01900 <span class="comment">/*****************************************************************************</span>
01901 <span class="comment">* MACアドレス読み出し</span>
01902 <span class="comment">*</span>
01903 <span class="comment">* シリアルEEPROMからMACアドレスを読み出す。</span>
01904 <span class="comment">* 読み出し成功でE_OK、失敗で(-1)を返す。</span>
01905 <span class="comment">******************************************************************************/</span>
01906 
<a name="l01907"></a><a class="code" href="lan9118_8c.html#a89">01907</a> ER <a class="code" href="lan9118_8c.html#a89">lan_get_mac</a>(UB *macaddr)
01908 {
01909     UB d[7];
01910 
01911     <span class="keywordflow">if</span> ((<a class="code" href="lan9118_8c.html#a87">lan_get_eep</a>(0x00, &amp;d[0]) != E_OK)
01912      || (<a class="code" href="lan9118_8c.html#a87">lan_get_eep</a>(0x01, &amp;d[1]) != E_OK)
01913      || (<a class="code" href="lan9118_8c.html#a87">lan_get_eep</a>(0x02, &amp;d[2]) != E_OK)
01914      || (<a class="code" href="lan9118_8c.html#a87">lan_get_eep</a>(0x03, &amp;d[3]) != E_OK)
01915      || (<a class="code" href="lan9118_8c.html#a87">lan_get_eep</a>(0x04, &amp;d[4]) != E_OK)
01916      || (<a class="code" href="lan9118_8c.html#a87">lan_get_eep</a>(0x05, &amp;d[5]) != E_OK)
01917      || (<a class="code" href="lan9118_8c.html#a87">lan_get_eep</a>(0x06, &amp;d[6]) != E_OK))
01918         <span class="keywordflow">return</span> -1;
01919 
01920     <span class="keywordflow">if</span> (d[0] != 0xa5)  <span class="comment">/* not save */</span>
01921         <span class="keywordflow">return</span> -1;
01922 
01923     macaddr[0] = d[1];
01924     macaddr[1] = d[2];
01925     macaddr[2] = d[3];
01926     macaddr[3] = d[4];
01927     macaddr[4] = d[5];
01928     macaddr[5] = d[6];
01929     <span class="keywordflow">return</span> E_OK;
01930 }
01931 
01932 <span class="comment">/*****************************************************************************</span>
01933 <span class="comment">* MACアドレス書き込み</span>
01934 <span class="comment">*</span>
01935 <span class="comment">* シリアルEEPROMにMACアドレスを書き込む。</span>
01936 <span class="comment">* 書き込み成功でE_OK、失敗で(-1)を返す。</span>
01937 <span class="comment">******************************************************************************/</span>
01938 
<a name="l01939"></a><a class="code" href="lan9118_8c.html#a90">01939</a> ER <a class="code" href="lan9118_8c.html#a90">lan_set_mac</a>(UB *macaddr)
01940 {
01941     UB *d = macaddr;
01942 
01943     <span class="keywordflow">if</span> ((<a class="code" href="lan9118_8c.html#a88">lan_set_eep</a>(0x00, 0xa5) != E_OK)
01944      || (<a class="code" href="lan9118_8c.html#a88">lan_set_eep</a>(0x01, d[0]) != E_OK)
01945      || (<a class="code" href="lan9118_8c.html#a88">lan_set_eep</a>(0x02, d[1]) != E_OK)
01946      || (<a class="code" href="lan9118_8c.html#a88">lan_set_eep</a>(0x03, d[2]) != E_OK)
01947      || (<a class="code" href="lan9118_8c.html#a88">lan_set_eep</a>(0x04, d[3]) != E_OK)
01948      || (<a class="code" href="lan9118_8c.html#a88">lan_set_eep</a>(0x05, d[4]) != E_OK)
01949      || (<a class="code" href="lan9118_8c.html#a88">lan_set_eep</a>(0x06, d[5]) != E_OK))
01950         <span class="keywordflow">return</span> -1;
01951     <span class="keywordflow">return</span> E_OK;
01952 }
01953 
01954 <span class="comment">/* end */</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Fri Sep 7 16:43:24 2012 for VA-300ドライバ by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.1 </small></address>
</body>
</html>
